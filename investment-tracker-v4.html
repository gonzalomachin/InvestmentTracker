<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tracker Pro v4.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-root: #0f1117;
            --bg-primary: #161822;
            --bg-secondary: #1c1f2e;
            --bg-card: #1c1f2e;
            --bg-card-hover: #232638;
            --bg-input: #161822;
            --border: #2a2d3d;
            --border-focus: #00c9a7;

            --text-primary: #f0f1f3;
            --text-secondary: #7b7e8e;
            --text-muted: #4f525f;

            --green: #00c9a7;
            --green-dim: rgba(0, 201, 167, 0.12);
            --red: #ff4d6a;
            --red-dim: rgba(255, 77, 106, 0.12);
            --blue: #4d9aff;
            --blue-dim: rgba(77, 154, 255, 0.12);
            --amber: #f5a623;
            --amber-dim: rgba(245, 166, 35, 0.12);
            --purple: #a78bfa;
            --purple-dim: rgba(167, 139, 250, 0.12);

            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;

            --shadow: 0 2px 12px rgba(0,0,0,0.25);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-root);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ‚îÄ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ‚îÄ */
        .container {
            max-width: 1480px;
            margin: 0 auto;
            padding: 28px 32px 40px;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        header {
            background: linear-gradient(180deg, #12141c 0%, #0f1117 100%);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        .header-inner {
            max-width: 1480px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .header-top > div:first-child {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        h1 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.3px;
            white-space: nowrap;
        }

        .version-badge {
            background: var(--green-dim);
            color: var(--green);
            padding: 2px 9px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .subtitle { display: none; }

        .btn-ghost-danger {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid transparent;
            padding: 9px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
        }

        .btn-ghost-danger:hover {
            background: var(--red-dim);
            color: var(--red);
            border-color: rgba(255,77,106,0.2);
        }

        /* ‚îÄ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ‚îÄ */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px 20px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--green-dim);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--green) 40%, var(--blue) 60%, transparent 100%);
            opacity: 0.7;
        }

        .card-title {
            font-size: 0.72rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .card-value {
            font-size: 1.72rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend-up { color: var(--green); font-weight: 600; }
        .trend-down { color: var(--red); font-weight: 600; }
        .success { color: var(--green); }
        .warning { color: var(--amber); }
        .danger { color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--bg-primary);
            padding: 6px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 9px 18px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.82rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.18s;
            white-space: nowrap;
            font-family: inherit;
            letter-spacing: 0.1px;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            background: var(--bg-card);
            color: var(--green);
            font-weight: 700;
            border-bottom: 2px solid var(--green);
            border-radius: 6px 6px 0 0;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        /* ‚îÄ‚îÄ‚îÄ PANELS / CARDS GENERALES ‚îÄ‚îÄ‚îÄ */
        .chart-container,
        .alerts-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            transition: border-color 0.25s;
        }

        .chart-container:hover,
        .alerts-container:hover {
            border-color: rgba(0, 201, 167, 0.25);
        }

        /* ‚îÄ‚îÄ‚îÄ PANEL TITLES ‚îÄ‚îÄ‚îÄ */
        .panel-title {
            font-size: 0.92rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 18px;
            letter-spacing: -0.1px;
        }

        .panel-title .dim {
            color: var(--text-muted);
            font-weight: 400;
            font-size: 0.88em;
            margin-left: 6px;
        }

        /* ‚îÄ‚îÄ‚îÄ RANGE PILLS (evoluci√≥n temporal) ‚îÄ‚îÄ‚îÄ */
        .range-pills {
            display: flex;
            gap: 4px;
            margin-bottom: 18px;
        }

        .range-pill {
            padding: 5px 13px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-root);
            color: var(--text-secondary);
            font-size: 0.76rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.2px;
        }

        .range-pill:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .range-pill.active {
            background: var(--green);
            border-color: var(--green);
            color: #0f1117;
            box-shadow: 0 2px 8px rgba(0, 201, 167, 0.3);
        }

        /* ‚îÄ‚îÄ‚îÄ CHART-HEADER (Holdings tab) ‚îÄ‚îÄ‚îÄ */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .chart-title {
            font-size: 0.92rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.1px;
        }

        .alerts-container {
            max-height: 600px;
            overflow-y: auto;
        }

        /* ‚îÄ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ‚îÄ */
        .alert {
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border-left: 3px solid;
            background: var(--bg-primary);
        }

        .alert-success {
            border-color: var(--green);
            background: var(--green-dim);
        }

        .alert-warning {
            border-color: var(--amber);
            background: var(--amber-dim);
        }

        .alert-danger {
            border-color: var(--red);
            background: var(--red-dim);
        }

        .alert-info {
            border-color: var(--blue);
            background: var(--blue-dim);
        }

        .alert-title {
            font-weight: 600;
            font-size: 0.88rem;
            margin-bottom: 4px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-text {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ‚îÄ INVESTMENT CARDS ‚îÄ‚îÄ‚îÄ */
        .investments-grid { display: grid; gap: 14px; }

        .investment-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px;
            transition: border-color 0.2s;
        }

        .investment-card:hover {
            border-color: rgba(0, 201, 167, 0.3);
        }

        .investment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .investment-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.2px;
        }

        .investment-badges {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .investment-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .badge-medio { background: var(--blue-dim); color: var(--blue); }
        .badge-largo { background: var(--purple-dim); color: var(--purple); }
        .badge-acciones { background: var(--red-dim); color: var(--red); }
        .badge-bonos { background: var(--blue-dim); color: var(--blue); }
        .badge-mixto { background: var(--amber-dim); color: var(--amber); }
        .badge-inmobiliario { background: var(--green-dim); color: var(--green); }
        .badge-crypto { background: var(--purple-dim); color: var(--purple); }
        .badge-materiasprimas { background: var(--amber-dim); color: var(--amber); }

        /* ‚îÄ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ‚îÄ */
        .progress-bar-container {
            background: var(--bg-root);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 0;
        }

        .progress-success { background: var(--green); }
        .progress-warning { background: var(--amber); }
        .progress-danger { background: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ DETAIL GRID ‚îÄ‚îÄ‚îÄ */
        .investment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 4px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .detail-item { display: flex; flex-direction: column; }

        .detail-label {
            font-size: 0.72rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
        .btn {
            padding: 9px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
            letter-spacing: 0.2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--green);
            color: #0f1117;
        }

        .btn-primary:hover {
            background: #00b896;
            box-shadow: 0 3px 12px rgba(0, 201, 167, 0.35);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--text-secondary);
            background: var(--bg-card-hover);
        }

        /* ‚îÄ‚îÄ‚îÄ MODALES ‚îÄ‚îÄ‚îÄ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 32px;
            border-radius: var(--radius-lg);
            max-width: 560px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            font-size: 1.18rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        /* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
        .form-group { margin-bottom: 18px; }

        .form-label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.82rem;
            letter-spacing: 0.2px;
        }

        .form-label small {
            color: var(--text-muted);
            font-weight: 400;
            display: block;
            margin-top: 3px;
            font-size: 0.88em;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.88rem;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--green-dim);
        }

        .form-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        /* ‚îÄ‚îÄ‚îÄ MOVEMENTS LIST ‚îÄ‚îÄ‚îÄ */
        .movements-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 14px;
        }

        .movement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            transition: border-color 0.15s;
        }

        .movement-item:hover { border-color: var(--text-muted); }

        .movement-date {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .movement-amount { font-weight: 600; font-size: 0.9rem; }

        .movement-type-aportacion { color: var(--green); }
        .movement-type-retirada { color: var(--red); }
        .movement-type-dividendo { color: var(--green); }
        .movement-type-comision { color: var(--red); }

        /* ‚îÄ‚îÄ‚îÄ BENCHMARKS ‚îÄ‚îÄ‚îÄ */
        .benchmark-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .benchmark-card {
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--blue);
        }

        /* ‚îÄ‚îÄ‚îÄ RISK METER ‚îÄ‚îÄ‚îÄ */
        .risk-meter {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--green) 0%, var(--amber) 50%, var(--red) 100%);
            border-radius: 4px;
            position: relative;
            margin: 20px 0;
        }

        .risk-indicator {
            position: absolute;
            top: -6px;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border: 3px solid var(--bg-card);
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        /* ‚îÄ‚îÄ‚îÄ MONTE CARLO / PROBABILITY ‚îÄ‚îÄ‚îÄ */
        .monte-carlo-container { margin-top: 20px; }

        .probability-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .probability-label {
            min-width: 120px;
            font-size: 0.82rem;
            color: var(--text-secondary);
        }

        .probability-fill {
            flex: 1;
            height: 22px;
            background: var(--bg-root);
            border-radius: 11px;
            overflow: hidden;
        }

        .probability-fill-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f1117;
            font-weight: 700;
            font-size: 0.78rem;
        }

        /* ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ */
        .info-tooltip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 50%;
            font-size: 0.65rem;
            cursor: help;
            margin-left: 5px;
            transition: border-color 0.2s;
        }

        .info-tooltip:hover { border-color: var(--green); color: var(--green); }

        /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            header { padding: 14px 18px; }
            .investment-details { grid-template-columns: repeat(2, 1fr); }
            .header-top { flex-direction: column; align-items: flex-start; }
            .card-value { font-size: 1.4rem; }
        }

        /* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
        @keyframes slideIn {
            from { transform: translateX(360px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(360px); opacity: 0; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active { animation: fadeIn 0.22s ease; }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="header-left">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" style="flex-shrink:0;">
                    <rect width="28" height="28" rx="7" fill="#00c9a7" fill-opacity="0.15"/>
                    <polyline points="4,20 10,14 14,17 20,9 24,12" stroke="#00c9a7" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="24" cy="12" r="2" fill="#00c9a7"/>
                </svg>
                <div>
                    <h1>Investment Tracker Pro <span class="version-badge">v4.0</span></h1>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="btnActualizarPrecios" onclick="actualizarTodasLasInversiones()" title="Actualiza precios desde Yahoo Finance">
                    ‚Üª Sync Precios
                </button>
                <button class="btn btn-secondary" onclick="exportarDatos()">‚Üì Exportar</button>
                <label class="btn btn-secondary" style="margin: 0; cursor: pointer;">
                    ‚Üë Excel
                    <input type="file" id="fileImportExcel" accept=".xlsx,.xls" onchange="importarExcel(event)" style="display: none;">
                </label>
                <label class="btn btn-secondary" style="margin: 0; cursor: pointer;">
                    ‚Üë JSON
                    <input type="file" accept=".json" onchange="importarDatos(event)" style="display: none;">
                </label>
                <button class="btn btn-ghost-danger" onclick="resetearDatos()">Reset</button>
            </div>
        </div>
    </header>
    <div class="container">

        <!-- Tabs de navegaci√≥n -->
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('overview')">Overview</button>
            <button class="tab" onclick="cambiarTab('inversiones')">Inversiones</button>
            <button class="tab" onclick="cambiarTab('analisis')">An√°lisis</button>
            <button class="tab" onclick="cambiarTab('proyecciones')">Proyecciones</button>
            <button class="tab" onclick="cambiarTab('benchmarks')">Benchmarks</button>
            <button class="tab" onclick="cambiarTab('holdings')">Holdings</button>
        </div>

        <!-- TAB: Overview -->
        <div id="tab-overview" class="tab-content active">
            <div class="summary-cards" id="summaryCards"></div>
            
            <div class="main-content">
                <!-- Gr√°fico 1: Aportaciones -->
                <div class="chart-container">
                    <h2 class="panel-title">Aportaciones Acumuladas</h2>
                    <div class="range-pills" id="rangePills">
                        <button class="range-pill active" data-range="ytd"  onclick="setRange(this,'ytd')">YTD</button>
                        <button class="range-pill"        data-range="1y"   onclick="setRange(this,'1y')">1A</button>
                        <button class="range-pill"        data-range="3y"   onclick="setRange(this,'3y')">3A</button>
                        <button class="range-pill"        data-range="5y"   onclick="setRange(this,'5y')">5A</button>
                        <button class="range-pill"        data-range="10y"  onclick="setRange(this,'10y')">10A</button>
                        <button class="range-pill"        data-range="all"  onclick="setRange(this,'all')">Todo</button>
                    </div>
                    <canvas id="aportacionesChart"></canvas>
                </div>

                <!-- Gr√°fico 2: Valor del Portfolio -->
                <div class="chart-container">
                    <h2 class="panel-title">Valor del Portfolio</h2>
                    <canvas id="valorChart"></canvas>
                </div>

                <div class="alerts-container">
                    <h2 class="panel-title">Alertas Inteligentes</h2>
                    <div id="alertsContainer"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Inversiones -->
        <div id="tab-inversiones" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="panel-title">Mis Inversiones</h2>
                <button class="btn btn-primary" onclick="openModal('inversion')">+ A√±adir Inversi√≥n</button>
            </div>
            <div class="investments-grid" id="investmentsGrid"></div>
        </div>

        <!-- TAB: An√°lisis -->
        <div id="tab-analisis" class="tab-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px;">
                <div class="chart-container">
                    <h2 class="panel-title">Diversificaci√≥n por Activo</h2>
                    <canvas id="diversificationChart"></canvas>
                    <div id="diversificationAnalysis" style="margin-top: 20px;"></div>
                </div>

                <div class="chart-container">
                    <h2 class="panel-title">Rentabilidad vs Objetivo</h2>
                    <canvas id="performanceChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2 class="panel-title">Contribuci√≥n al Crecimiento</h2>
                    <canvas id="contributionChart"></canvas>
                    <p style="margin-top: 12px; color: var(--text-secondary); font-size: 0.82rem; line-height: 1.5;">
                        Este gr√°fico muestra cu√°nto de tu crecimiento viene de rentabilidad vs aportaciones
                    </p>
                </div>

                <div class="chart-container">
                    <h2 class="panel-title">An√°lisis de Riesgo</h2>
                    <div id="riskAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Proyecciones -->
        <div id="tab-proyecciones" class="tab-content">
            <div class="chart-container">
                <h2 class="panel-title">Simulaci√≥n Monte Carlo</h2>
                <p style="color: var(--text-muted); margin-bottom: 18px; font-size: 0.82rem;">
                    Simulaci√≥n de 1,000 escenarios posibles basados en rentabilidad hist√≥rica y volatilidad
                </p>
                <canvas id="monteCarloChart"></canvas>
                <div id="monteCarloStats" class="monte-carlo-container"></div>
            </div>

            <div class="chart-container" style="margin-top: 30px;">
                <h2 class="panel-title">Probabilidad de √âxito</h2>
                <div id="probabilityAnalysis"></div>
            </div>
        </div>

        <!-- TAB: Benchmarks -->
        <div id="tab-benchmarks" class="tab-content">
            <div class="chart-container">
                <h2 class="panel-title">Comparaci√≥n con Benchmarks</h2>
                <p style="color: var(--text-muted); margin-bottom: 18px; font-size: 0.82rem;">
                    Compara tu rentabilidad con los principales √≠ndices del mercado
                </p>
                <canvas id="benchmarkChart"></canvas>
                <div class="benchmark-comparison" id="benchmarkComparison"></div>
            </div>
        </div>

        <!-- TAB: Holdings & M√©tricas -->
        <div id="tab-holdings" class="tab-content">
            <div id="holdingsContent"></div>
        </div>

        <!-- Modal para a√±adir/editar inversi√≥n -->
        <div class="modal" id="inversionModal">
            <div class="modal-content">
                <div class="modal-header">Nueva Inversi√≥n</div>
                <form id="inversionForm">
                    <div class="form-group">
                        <label class="form-label">Nombre de la inversi√≥n</label>
                        <input type="text" class="form-input" id="nombre" required placeholder="Ej: Acciones Tech">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de activo</label>
                        <select class="form-select" id="tipoActivo" required>
                            <option value="">Selecciona tipo</option>
                            <option value="acciones">üìà Acciones / ETFs</option>
                            <option value="bonos">üìä Bonos / Renta Fija</option>
                            <option value="mixto">üîÑ Fondo Mixto</option>
                            <option value="inmobiliario">üè† Inmobiliario / REITs</option>
                            <option value="crypto">‚Çø Criptomonedas</option>
                            <option value="materiasprimas">ü•á Materias Primas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Ticker (opcional - para auto-actualizaci√≥n de precios)
                            <button type="button" onclick="mostrarGuiaTickers()" style="
                                margin-left: 8px;
                                padding: 2px 8px;
                                font-size: 0.75em;
                                background: var(--blue-dim);
                                color: var(--blue);
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                            ">? Gu√≠a</button>
                        </label>
                        <input type="text" class="form-input" id="ticker" placeholder="Ej: AAPL, TEF.MC, BTC-USD">
                        <small style="color: var(--text-secondary); font-size: 0.85em;">
                            USA: AAPL | Espa√±a: TEF.MC | UK: LLOY.L | Crypto: BTC-USD
                            <a href="#" onclick="mostrarGuiaTickers(); return false;" style="color: var(--green); margin-left: 8px;">Ver todos</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ISIN (opcional - para an√°lisis de fondos)</label>
                        <input type="text" class="form-input" id="isin" placeholder="Ej: US0378331005">
                        <small style="color: var(--text-secondary); font-size: 0.85em;">C√≥digo internacional de 12 caracteres</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categor√≠a de fondo (si aplica)</label>
                        <select class="form-select" id="categoria">
                            <option value="">N/A</option>
                            <option value="value">Value (Valor)</option>
                            <option value="growth">Growth (Crecimiento)</option>
                            <option value="blend">Blend (Mixto)</option>
                            <option value="tech">Technology</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Financial</option>
                            <option value="consumer">Consumer</option>
                            <option value="energy">Energy</option>
                            <option value="global">Global / World</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Plazo de inversi√≥n</label>
                        <select class="form-select" id="plazo" required>
                            <option value="">Selecciona un plazo</option>
                            <option value="medio">Medio Plazo (1-3 a√±os)</option>
                            <option value="largo">Largo Plazo (3+ a√±os)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Inversi√≥n inicial (‚Ç¨)</label>
                        <input type="number" class="form-input" id="inversionInicial" required placeholder="5000" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha de inversi√≥n inicial</label>
                        <input type="date" class="form-input" id="fechaInicio" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Valor actual (‚Ç¨)</label>
                        <input type="number" class="form-input" id="valorActual" required placeholder="5500" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Objetivo final (‚Ç¨)</label>
                        <input type="number" class="form-input" id="objetivo" required placeholder="10000" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha objetivo</label>
                        <input type="date" class="form-input" id="fechaObjetivo" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Rentabilidad esperada anual (%)
                            <span class="info-tooltip" title="Rentabilidad que esperas obtener anualmente">?</span>
                        </label>
                        <input type="number" class="form-input" id="rentabilidadEsperada" required placeholder="8" step="0.1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Volatilidad estimada (%)
                            <span class="info-tooltip" title="Desviaci√≥n est√°ndar anual. Acciones: 15-20%, Bonos: 5-10%">?</span>
                        </label>
                        <input type="number" class="form-input" id="volatilidad" placeholder="15" step="0.1">
                    </div>


                    <div class="form-group" id="groupNumAcciones" style="display: none;">
                        <label class="form-label">
                            N√∫mero de acciones/unidades
                            <span class="info-tooltip" title="Solo para acciones individuales o crypto">?</span>
                        </label>
                        <input type="number" class="form-input" id="numAcciones" placeholder="100" step="0.00000001" oninput="calcularValorActualDesdeAcciones()">
                    </div>

                    <div class="form-group" id="groupPrecioCompra" style="display: none;">
                        <label class="form-label">
                            Precio de compra (‚Ç¨/unidad)
                            <span class="info-tooltip" title="Precio unitario al que compraste">?</span>
                        </label>
                        <input type="number" class="form-input" id="precioCompra" placeholder="50.25" step="0.01" oninput="calcularValorActualDesdeAcciones()">
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancelar</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para a√±adir movimiento -->
        <div class="modal" id="movimientoModal">
            <div class="modal-content">
                <div class="modal-header">A√±adir Movimiento</div>
                <form id="movimientoForm">
                    <input type="hidden" id="movimiento_inversionId">
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de movimiento</label>
                        <select class="form-select" id="movimiento_tipo" required>
                            <option value="aportacion">üí∞ Aportaci√≥n (Entrada de capital)</option>
                            <option value="retirada">üí∏ Retirada (Salida de capital)</option>
                            <option value="dividendo">üìà Dividendo Cobrado</option>
                            <option value="comision">üí≥ Comisi√≥n / Gasto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cantidad (‚Ç¨)</label>
                        <input type="number" class="form-input" id="movimiento_cantidad" required placeholder="1000" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="movimiento_fecha" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripci√≥n (opcional)</label>
                        <input type="text" class="form-input" id="movimiento_descripcion" placeholder="Ej: Aportaci√≥n mensual Enero">
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancelar</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">A√±adir</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para importar movimientos desde Excel/CSV -->
        <div class="modal" id="importMovimientosModal">
            <div class="modal-content">
                <div class="modal-header">Importar Movimientos desde Excel/CSV</div>
                
                <div style="background: var(--blue-dim); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-bottom: 10px; color: var(--blue);">üìã Formato requerido:</h4>
                    <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">
                        Tu archivo Excel o CSV debe tener estas columnas (en este orden):
                    </p>
                    <div style="background: var(--bg-root); padding: 10px; border-radius: 5px; font-family: "DM Mono", monospace; border: 1px solid var(--border); font-size: 0.85em;">
                        <strong>Fecha | Tipo | Cantidad | Descripci√≥n</strong><br>
                        2024-01-15 | aportacion | 1000 | Aportaci√≥n mensual<br>
                        2024-02-15 | aportacion | 1000 | Aportaci√≥n mensual<br>
                        2024-03-20 | retirada | 500 | Retiro parcial
                    </div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                        ‚Ä¢ <strong>Fecha:</strong> Formato YYYY-MM-DD (ej: 2024-01-15)<br>
                        ‚Ä¢ <strong>Tipo:</strong> "aportacion" o "retirada"<br>
                        ‚Ä¢ <strong>Cantidad:</strong> N√∫mero sin s√≠mbolo ‚Ç¨ (ej: 1000.50)<br>
                        ‚Ä¢ <strong>Descripci√≥n:</strong> Texto opcional
                    </p>
                </div>

                <div class="form-group">
                    <label class="btn btn-primary" style="width: 100%; margin: 0; text-align: center;">
                        üì• Seleccionar archivo Excel/CSV
                        <input type="file" id="importMovimientosFile" accept=".csv,.xlsx,.xls" style="display: none;" onchange="procesarArchivoMovimientos(event)">
                    </label>
                </div>

                <div class="form-group">
                    <button class="btn btn-secondary" onclick="descargarPlantillaMovimientos()" style="width: 100%;">
                        üìÑ Descargar Plantilla Excel
                    </button>
                </div>

                <div id="previewMovimientos" style="display: none; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Vista previa (primeros 5 movimientos):</h4>
                    <div id="previewMovimientosContent" style="max-height: 200px; overflow-y: auto; background: var(--bg-primary); padding: 10px; border-radius: 8px;"></div>
                    <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9em;">
                        Total: <strong id="totalMovimientosPreview">0</strong> movimientos
                    </p>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarImportMovimientos" onclick="confirmarImportMovimientos()" style="flex: 1; display: none;">
                        ‚úÖ Importar Movimientos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATOS Y ESTADO GLOBAL
        // ============================================
        
        let inversiones = [];
        let charts = {};
        let currentTab = 'overview';
        let movimientosTemp = []; // Para importaci√≥n temporal

        // Benchmarks simulados (en producci√≥n vendr√≠an de API)
        const benchmarks = {
            'SP500': { nombre: 'S&P 500', rentabilidad: 10.5, volatilidad: 18 },
            'MSCI_WORLD': { nombre: 'MSCI World', rentabilidad: 9.2, volatilidad: 16 },
            'EUROSTOXX50': { nombre: 'Euro Stoxx 50', rentabilidad: 7.8, volatilidad: 20 },
            'BONOS_GLOBAL': { nombre: 'Bonos Globales', rentabilidad: 3.5, volatilidad: 6 }
        };

        // Datos de ejemplo
        const inversionesDefault = [
            {
                id: 1,
                nombre: "Acciones Tech Global",
                tipoActivo: "acciones",
                plazo: "largo",
                inversionInicial: 10000,
                fechaInicio: "2023-01-15",
                valorActual: 13200,
                objetivo: 30000,
                fechaObjetivo: "2028-12-31",
                rentabilidadEsperada: 12,
                volatilidad: 18,
                movimientos: [
                    { tipo: 'aportacion', cantidad: 10000, fecha: '2023-01-15' },
                    { tipo: 'aportacion', cantidad: 1000, fecha: '2023-06-01' },
                    { tipo: 'aportacion', cantidad: 1000, fecha: '2023-12-01' },
                    { tipo: 'aportacion', cantidad: 1000, fecha: '2024-06-01' }
                ]
            },
            {
                id: 2,
                nombre: "Fondos Indexados Europeos",
                tipoActivo: "mixto",
                plazo: "medio",
                inversionInicial: 5000,
                fechaInicio: "2023-03-01",
                valorActual: 6100,
                objetivo: 10000,
                fechaObjetivo: "2026-12-31",
                rentabilidadEsperada: 8,
                volatilidad: 12,
                movimientos: [
                    { tipo: 'aportacion', cantidad: 5000, fecha: '2023-03-01' },
                    { tipo: 'aportacion', cantidad: 500, fecha: '2024-01-01' }
                ]
            },
            {
                id: 3,
                nombre: "Bonos Corporativos",
                tipoActivo: "bonos",
                plazo: "medio",
                inversionInicial: 8000,
                fechaInicio: "2023-06-01",
                valorActual: 8600,
                objetivo: 12000,
                fechaObjetivo: "2027-06-01",
                rentabilidadEsperada: 5,
                volatilidad: 6,
                movimientos: [
                    { tipo: 'aportacion', cantidad: 8000, fecha: '2023-06-01' }
                ]
            }
        ];

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================


        // -- Chart.js dark-theme defaults --
        Chart.defaults.color = '#7b7e8e';
        Chart.defaults.borderColor = '#2a2d3d';
        Chart.defaults.plugins.legend.labels.color = '#f0f1f3';
        Chart.defaults.plugins.tooltip.backgroundColor = '#1c1f2e';
        Chart.defaults.plugins.tooltip.titleColor = '#f0f1f3';
        Chart.defaults.plugins.tooltip.bodyColor = '#7b7e8e';
        Chart.defaults.plugins.tooltip.borderColor = '#2a2d3d';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.scale.grid.color = 'rgba(42,45,61,0.6)';
        Chart.defaults.scale.ticks.color = '#7b7e8e';


        function mostrarGuiaTickers() {
            const guia = obtenerGuiaTickers();
            alert(guia);
        }
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.createElement('div');
            const colores = {
                success: '#00c9a7',
                warning: '#f5a623',
                danger: '#ff4d6a',
                info: '#4d9aff'
            };
            notif.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: rgba(28,31,46,0.92);
                border: 1px solid ${colores[tipo]};
                color: #f0f1f3;
                padding: 14px 22px;
                border-radius: 10px;
                box-shadow: 0 8px 28px rgba(0,0,0,0.45);
                z-index: 10000;
                font-weight: 600;
                font-size: 0.88rem;
                animation: slideIn 0.28s cubic-bezier(.22,1,.36,1);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-left: 3px solid ${colores[tipo]};
            `;
            notif.textContent = mensaje;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function formatNumber(num) {
            return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getDaysRemaining(dateString) {
            const today = new Date();
            const targetDate = new Date(dateString);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        function getDaysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        // ============================================
        // C√ÅLCULOS FINANCIEROS AVANZADOS
        // ============================================

        // Calcular TIR (Tasa Interna de Retorno) real
        function calcularTIR(inversion) {
            if (!inversion.movimientos || inversion.movimientos.length === 0) {
                return calcularRentabilidadSimple(inversion);
            }

            const movimientos = [...inversion.movimientos].sort((a, b) => 
                new Date(a.fecha) - new Date(b.fecha)
            );

            const fechaInicio = new Date(movimientos[0].fecha);
            const fechaActual = new Date();
            const diasTotal = getDaysBetween(fechaInicio, fechaActual);
            
            if (diasTotal <= 0) return 0;

            // Construir flujos de caja
            const flujos = movimientos.map(m => ({
                fecha: new Date(m.fecha),
                cantidad: m.tipo === 'aportacion' ? -m.cantidad : m.cantidad
            }));

            // A√±adir valor actual como √∫ltimo flujo
            flujos.push({
                fecha: fechaActual,
                cantidad: inversion.valorActual
            });

            // Calcular TIR usando m√©todo Newton-Raphson
            let tir = 0.1; // Estimaci√≥n inicial 10%
            const maxIteraciones = 100;
            const tolerancia = 0.0001;

            for (let i = 0; i < maxIteraciones; i++) {
                let vpn = 0;
                let derivada = 0;

                for (const flujo of flujos) {
                    const dias = getDaysBetween(fechaInicio, flujo.fecha);
                    const factor = Math.pow(1 + tir, dias / 365);
                    vpn += flujo.cantidad / factor;
                    derivada -= (flujo.cantidad * dias / 365) / Math.pow(1 + tir, (dias / 365) + 1);
                }

                if (Math.abs(vpn) < tolerancia) break;
                if (Math.abs(derivada) < 0.000001) break;

                tir = tir - vpn / derivada;
                
                if (tir < -0.99) tir = -0.99;
                if (tir > 10) tir = 10;
            }

            return tir * 100;
        }

        // Calcular rentabilidad simple (fallback)
        function calcularRentabilidadSimple(inversion) {
            const fechaInicio = new Date(inversion.fechaInicio);
            const fechaActual = new Date();
            const anosTranscurridos = (fechaActual - fechaInicio) / (1000 * 60 * 60 * 24 * 365.25);
            
            if (anosTranscurridos <= 0 || inversion.inversionInicial <= 0) return 0;
            
            const totalAportado = inversion.movimientos ?
                inversion.movimientos
                    .filter(m => m.tipo === 'aportacion')
                    .reduce((sum, m) => sum + m.cantidad, 0) :
                inversion.inversionInicial;

            return (Math.pow(inversion.valorActual / totalAportado, 1 / anosTranscurridos) - 1) * 100;
        }

        // Calcular aportaci√≥n mensual necesaria con TIR
        function calcularAportacionMensual(inversion) {
            const fechaActual = new Date();
            const fechaObjetivo = new Date(inversion.fechaObjetivo);
            
            const mesesRestantes = (fechaObjetivo.getFullYear() - fechaActual.getFullYear()) * 12 + 
                                   (fechaObjetivo.getMonth() - fechaActual.getMonth());
            
            if (mesesRestantes <= 0) return 0;

            const rentabilidadMensual = inversion.rentabilidadEsperada / 100 / 12;
            const valorFuturoCapitalActual = inversion.valorActual * Math.pow(1 + rentabilidadMensual, mesesRestantes);
            const diferencia = inversion.objetivo - valorFuturoCapitalActual;
            
            if (diferencia <= 0) return 0;
            
            const aportacionMensual = diferencia * rentabilidadMensual / 
                                     (Math.pow(1 + rentabilidadMensual, mesesRestantes) - 1);
            
            return Math.max(0, aportacionMensual);
        }

        // Simulaci√≥n Monte Carlo
        function simularMonteCarlo(inversion, numSimulaciones = 1000) {
            const fechaActual = new Date();
            const fechaObjetivo = new Date(inversion.fechaObjetivo);
            const anosRestantes = (fechaObjetivo - fechaActual) / (1000 * 60 * 60 * 24 * 365.25);
            
            if (anosRestantes <= 0) return { escenarios: [], probabilidadExito: 0 };

            const aportacionMensual = calcularAportacionMensual(inversion);
            const mesesRestantes = Math.ceil(anosRestantes * 12);
            
            const rentabilidadMedia = inversion.rentabilidadEsperada / 100 / 12;
            const volatilidad = (inversion.volatilidad || 15) / 100 / Math.sqrt(12);

            const escenarios = [];

            for (let sim = 0; sim < numSimulaciones; sim++) {
                let valor = inversion.valorActual;
                
                for (let mes = 0; mes < mesesRestantes; mes++) {
                    // Rentabilidad mensual con componente aleatorio (distribuci√≥n normal)
                    const random = (Math.random() + Math.random() + Math.random() + Math.random() + 
                                  Math.random() + Math.random() - 3) / 3; // Aproximaci√≥n Box-Muller
                    const rentabilidadMes = rentabilidadMedia + volatilidad * random;
                    
                    valor = valor * (1 + rentabilidadMes) + aportacionMensual;
                }
                
                escenarios.push(valor);
            }

            escenarios.sort((a, b) => a - b);
            
            const exitos = escenarios.filter(v => v >= inversion.objetivo).length;
            const probabilidadExito = (exitos / numSimulaciones) * 100;

            return {
                escenarios,
                probabilidadExito,
                percentil10: escenarios[Math.floor(numSimulaciones * 0.1)],
                percentil50: escenarios[Math.floor(numSimulaciones * 0.5)],
                percentil90: escenarios[Math.floor(numSimulaciones * 0.9)]
            };
        }

        // An√°lisis de diversificaci√≥n
        function analizarDiversificacion() {
            if (inversiones.length === 0) return { concentracion: 0, recomendacion: '' };

            const valorTotal = inversiones.reduce((sum, inv) => sum + getValorActual(inv), 0);
            const porActivo = {};

            inversiones.forEach(inv => {
                const tipo = inv.tipoActivo || 'otros';
                porActivo[tipo] = (porActivo[tipo] || 0) + getValorActual(inv);
            });

            // Calcular √≠ndice Herfindahl de concentraci√≥n
            let herfindahl = 0;
            for (const tipo in porActivo) {
                const proporcion = porActivo[tipo] / valorTotal;
                herfindahl += proporcion * proporcion;
            }

            // HHI: 0-0.15 = Alta diversificaci√≥n, 0.15-0.25 = Media, >0.25 = Baja
            let nivel, recomendacion;
            if (herfindahl < 0.15) {
                nivel = 'Alta';
                recomendacion = ' Excelente diversificaci√≥n. Tu portfolio est√° bien distribuido.';
            } else if (herfindahl < 0.25) {
                nivel = 'Media';
                recomendacion = 'Ô∏è Diversificaci√≥n moderada. Considera a√±adir m√°s tipos de activos.';
            } else {
                nivel = 'Baja';
                recomendacion = ' Portfolio concentrado. Alto riesgo. Diversifica en diferentes activos.';
            }

            return { 
                concentracion: herfindahl,
                nivel,
                recomendacion,
                distribucion: porActivo
            };
        }

        // ============================================
        // GESTI√ìN DE DATOS (localStorage)
        // ============================================


        // -- Sistema de snapshots para cierre de a√±o --
        function guardarSnapshotSiCorresponde() {
            const hoy = new Date();
            const a√±o = hoy.getFullYear();
            const mes = hoy.getMonth();
            const dia = hoy.getDate();
            
            // Solo guardar autom√°ticamente el 31/12 o el 1/1
            if ((mes === 11 && dia === 31) || (mes === 0 && dia === 1)) {
                const a√±oSnapshot = mes === 11 ? a√±o : a√±o - 1;
                guardarSnapshot(a√±oSnapshot);
            }
        }

        function guardarSnapshot(a√±o) {
            const valorTotal = inversiones.reduce((sum, inv) => sum + getValorActual(inv), 0);
            
            let snapshots = JSON.parse(localStorage.getItem('portfolioSnapshots') || '{}');
            snapshots[a√±o] = {
                valor: valorTotal,
                fecha: new Date().toISOString(),
                numInversiones: inversiones.length
            };
            
            localStorage.setItem('portfolioSnapshots', JSON.stringify(snapshots));
            console.log(`Snapshot guardado para ${a√±o}: ‚Ç¨${valorTotal.toFixed(2)}`);
        }

        function obtenerSnapshot(a√±o) {
            const snapshots = JSON.parse(localStorage.getItem('portfolioSnapshots') || '{}');
            return snapshots[a√±o] || null;
        }

        function obtenerValorEnFechaConSnapshot(fecha) {
            const a√±o = fecha.getFullYear();
            const mes = fecha.getMonth();
            const dia = fecha.getDate();
            
            // Si es 31/12, intentar usar snapshot
            if (mes === 11 && dia === 31) {
                const snapshot = obtenerSnapshot(a√±o);
                if (snapshot) return snapshot.valor;
            }
            
            // Sino, calcular normalmente
            return null;
        }
        function guardarDatos() {
            try {
                localStorage.setItem('inversionesTrackerV3', JSON.stringify(inversiones));
                guardarSnapshotSiCorresponde();
            } catch (error) {
                console.error('Error al guardar:', error);
            }
        }

        function cargarDatos() {
            try {
                const datos = localStorage.getItem('inversionesTrackerV3');
                if (datos) {
                    const parsed = JSON.parse(datos);
                    if (parsed && parsed.length > 0) {
                        inversiones = parsed;
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error al cargar:', error);
            }
            inversiones = JSON.parse(JSON.stringify(inversionesDefault));
            return false;
        }

        function exportarDatos() {
            const dataStr = JSON.stringify(inversiones, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inversiones-pro-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            mostrarNotificacion(' Datos exportados correctamente');
        }

        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    if (Array.isArray(datos)) {
                        inversiones = datos;
                        guardarDatos();
                        init();
                        mostrarNotificacion(' Datos importados correctamente');
                    } else {
                        mostrarNotificacion(' Formato inv√°lido', 'danger');
                    }
                } catch (error) {
                    mostrarNotificacion(' Error al importar', 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============================================
        // IMPORTAR MODELO EXCEL COMPLETO
        // ============================================
        async function importarExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = '';

            try {
                const buf  = await file.arrayBuffer();
                const wb   = XLSX.read(buf);

                const shInv = wb.Sheets[wb.SheetNames.find(n =>
                    n.toLowerCase().includes('inversion')
                ) || wb.SheetNames[0]];
                const rowsInv = XLSX.utils.sheet_to_json(shInv, { header: 1 });

                let rowsMov = [];
                const shMovName = wb.SheetNames.find(n =>
                    n.toLowerCase().includes('movimiento')
                );
                if (shMovName) {
                    rowsMov = XLSX.utils.sheet_to_json(wb.Sheets[shMovName], { header: 1 });
                }

                const nuevasInversiones = parsearInversionesExcel(rowsInv);
                if (nuevasInversiones.length === 0) {
                    mostrarNotificacion(' No se encontraron inversiones v√°lidas', 'danger');
                    return;
                }

                if (rowsMov.length > 0) {
                    const movParsed = parsearMovimientosExcel(rowsMov);
                    nuevasInversiones.forEach(inv => {
                        inv.movimientos = movParsed.filter(m =>
                            m._invNombre && m._invNombre.trim().toLowerCase() === inv.nombre.trim().toLowerCase()
                        ).map(m => ({
                            fecha:       m.fecha,
                            tipo:        m.tipo,
                            cantidad:    m.cantidad,
                            descripcion: m.descripcion || '',
                            numAcciones: m.numAcciones || null,
                            precio:      m.precio || null
                        }));
                    });
                }

                const movTotal = nuevasInversiones.reduce((s, i) => s + (i.movimientos || []).length, 0);
                const reemplazar = confirm(
                    `Se importar√°n ${nuevasInversiones.length} inversi√≥n(es) con ${movTotal} movimiento(s).\n\n` +
                    `[Aceptar]  = Reemplazar todo el portfolio\n` +
                    `[Cancelar] = A√±adir al portfolio existente`
                );

                if (reemplazar) {
                    inversiones = nuevasInversiones;
                } else {
                    nuevasInversiones.forEach(ni => {
                        const existe = inversiones.find(i => i.nombre.trim().toLowerCase() === ni.nombre.trim().toLowerCase());
                        if (existe) {
                            if (ni.movimientos) {
                                if (!existe.movimientos) existe.movimientos = [];
                                ni.movimientos.forEach(nm => {
                                    const dup = existe.movimientos.some(em =>
                                        em.fecha === nm.fecha && em.tipo === nm.tipo && em.cantidad === nm.cantidad
                                    );
                                    if (!dup) existe.movimientos.push(nm);
                                });
                                existe.movimientos.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
                            }
                        } else {
                            inversiones.push(ni);
                        }
                    });
                }

                guardarDatos();
                init();
                mostrarNotificacion(` ${nuevasInversiones.length} inversiones + ${movTotal} movimientos importados`, 'success');

            } catch (err) {
                console.error(err);
                mostrarNotificacion(' Error: ' + err.message, 'danger');
            }
        }

        function excelDateToISO(val) {
            if (val == null) return null;
            if (typeof val === 'number') {
                const d = new Date((val - 25569) * 86400000);
                return d.toISOString().split('T')[0];
            }
            if (typeof val === 'string') {
                const d = new Date(val);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
                const m = val.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                if (m) {
                    const y = m[3].length === 2 ? '20' + m[3] : m[3];
                    return `${y}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
                }
            }
            return null;
        }

        function findCol(headerRow, ...names) {
            if (!headerRow) return -1;
            const lower = headerRow.map(h => h != null ? String(h).toLowerCase().trim() : '');
            for (const n of names) {
                const search = n.toLowerCase();
                let idx = lower.indexOf(search);
                if (idx !== -1) return idx;
                idx = lower.findIndex(h => h.startsWith(search));
                if (idx !== -1) return idx;
            }
            return -1;
        }

        function parsearInversionesExcel(rows) {
            let hdrIdx = -1;
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                if (rows[i] && rows[i].some(c => { if (c == null) return false; const s = String(c).trim().toLowerCase(); return s === 'nombre' || (s.startsWith('nombre') && s.length < 25); })) {
                    hdrIdx = i; break;
                }
            }
            if (hdrIdx === -1) return [];

            const hdr = rows[hdrIdx];
            const iNombre     = findCol(hdr, 'nombre');
            const iTipo       = findCol(hdr, 'tipo de activo', 'tipo activo', 'tipo');
            const iTicker     = findCol(hdr, 'ticker');
            const iISIN       = findCol(hdr, 'isin');
            const iCategoria  = findCol(hdr, 'categor√≠a', 'categoria');
            const iPlazo      = findCol(hdr, 'plazo');
            const iFechaIn    = findCol(hdr, 'fecha inicio', 'fecha de inicio');
            const iInvInicial = findCol(hdr, 'inversi√≥n inicial', 'inversion inicial');
            const iValActual  = findCol(hdr, 'valor actual');
            const iObjetivo   = findCol(hdr, 'objetivo');
            const iFechaObj   = findCol(hdr, 'fecha objetivo', 'fecha de objetivo');
            const iRentEsp    = findCol(hdr, 'rentabilidad esperada', 'rentabilidad');
            const iVolatil    = findCol(hdr, 'volatilidad');
            const iNumAcc     = findCol(hdr, 'num. acciones', 'num acciones', 'numacciones');
            const iPrecioC    = findCol(hdr, 'precio compra', 'precio');

            const result = [];
            for (let i = hdrIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r || !r[iNombre]) continue;
                const nombre = String(r[iNombre]).trim();
                if (!nombre || nombre.toLowerCase().includes('a√±ade')) continue;

                const inv = {
                    id:                  Date.now() + i,
                    nombre:              nombre,
                    tipoActivo:          iTipo >= 0 && r[iTipo]  ? String(r[iTipo]).trim().toLowerCase()  : 'mixto',
                    ticker:              iTicker >= 0 && r[iTicker] ? String(r[iTicker]).trim().toUpperCase() : null,
                    isin:                iISIN >= 0 && r[iISIN]  ? String(r[iISIN]).trim().toUpperCase()   : null,
                    categoria:           iCategoria >= 0 && r[iCategoria] ? String(r[iCategoria]).trim()   : null,
                    plazo:               iPlazo >= 0 && r[iPlazo] ? String(r[iPlazo]).trim().toLowerCase()  : 'largo',
                    fechaInicio:         iFechaIn >= 0 ? excelDateToISO(r[iFechaIn])  : null,
                    inversionInicial:    iInvInicial >= 0 ? parseFloat(r[iInvInicial]) || 0 : 0,
                    valorActual:         iValActual >= 0 ? parseFloat(r[iValActual])  || 0 : 0,
                    objetivo:            iObjetivo >= 0  ? parseFloat(r[iObjetivo])   || 0 : 0,
                    fechaObjetivo:       iFechaObj >= 0  ? excelDateToISO(r[iFechaObj]) : null,
                    rentabilidadEsperada:iRentEsp >= 0   ? parseFloat(r[iRentEsp])    || 8 : 8,
                    volatilidad:         iVolatil >= 0   ? parseFloat(r[iVolatil])    || 15 : 15,
                    numAcciones:         iNumAcc >= 0 && r[iNumAcc] ? parseFloat(r[iNumAcc]) || null : null,
                    precioCompra:        iPrecioC >= 0 && r[iPrecioC] ? parseFloat(r[iPrecioC]) || null : null,
                    movimientos:         []
                };

                if (!inv.valorActual && inv.numAcciones && inv.precioCompra) {
                    inv.valorActual = inv.numAcciones * inv.precioCompra;
                }
                if (!inv.inversionInicial && inv.valorActual) {
                    inv.inversionInicial = inv.valorActual;
                }

                result.push(inv);
            }
            return result;
        }

        function parsearMovimientosExcel(rows) {
            let hdrIdx = -1;
            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                if (rows[i] && rows[i].some(c => { if (c == null) return false; const s = String(c).trim().toLowerCase(); return s === 'nombre' || (s.startsWith('nombre') && s.length < 25); })) {
                    hdrIdx = i; break;
                }
            }
            if (hdrIdx === -1) return [];

            const hdr = rows[hdrIdx];
            const iNombre  = findCol(hdr, 'nombre inversi√≥n', 'nombre inversion', 'nombre');
            const iFecha   = findCol(hdr, 'fecha');
            const iTipo    = findCol(hdr, 'tipo');
            const iCantidad= findCol(hdr, 'cantidad');
            const iNumAcc  = findCol(hdr, 'num. acciones', 'num acciones');
            const iPrecio  = findCol(hdr, 'precio/acc', 'precio');
            const iDesc    = findCol(hdr, 'descripci√≥n', 'descripcion');

            const tiposValidos = ['aportacion','retirada','dividendo','comision'];
            const result = [];

            for (let i = hdrIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r || !r[iNombre]) continue;
                const nombre = String(r[iNombre]).trim();
                if (!nombre || nombre.toLowerCase().includes('a√±ade')) continue;

                const tipo = iTipo >= 0 && r[iTipo] ? String(r[iTipo]).trim().toLowerCase() : null;
                if (!tipo || !tiposValidos.includes(tipo)) continue;

                const fecha = iFecha >= 0 ? excelDateToISO(r[iFecha]) : null;
                if (!fecha) continue;

                const cantidad = iCantidad >= 0 ? parseFloat(r[iCantidad]) : 0;
                if (isNaN(cantidad) || cantidad <= 0) continue;

                result.push({
                    _invNombre:  nombre,
                    fecha:       fecha,
                    tipo:        tipo,
                    cantidad:    cantidad,
                    numAcciones: iNumAcc >= 0 && r[iNumAcc] ? parseFloat(r[iNumAcc]) || null : null,
                    precio:      iPrecio >= 0 && r[iPrecio] ? parseFloat(r[iPrecio]) || null : null,
                    descripcion: iDesc >= 0 && r[iDesc]    ? String(r[iDesc]).trim()       : ''
                });
            }
            return result;
        }
        function resetearDatos() {
            if (confirm('Ô∏è ¬øEst√°s seguro? Esto eliminar√° todas tus inversiones.')) {
                localStorage.removeItem('inversionesTrackerV3');
                inversiones = JSON.parse(JSON.stringify(inversionesDefault));
                guardarDatos();
                init();
                mostrarNotificacion(' Datos reseteados', 'info');
            }
        }

        // ============================================
        // NAVEGACI√ìN POR TABS
        // ============================================

        function cambiarTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Actualizar contenido seg√∫n tab
            if (tabName === 'overview') {
                actualizarOverview();
            } else if (tabName === 'inversiones') {
                renderInversiones();
            } else if (tabName === 'analisis') {
                renderAnalisis();
            } else if (tabName === 'proyecciones') {
                renderProyecciones();
            } else if (tabName === 'benchmarks') {
                renderBenchmarks();
            } else if (tabName === 'holdings') {
                renderHoldingsYMetricas();
            }
        }

        // ============================================
        // RENDERIZADO: OVERVIEW
        // ============================================


        // -- Obtener valor actual de una inversi√≥n (auto-calculado si tiene acciones+precio) --

        // -- Calcular n√∫mero total de acciones desde movimientos --
        function calcularNumAccionesTotales(inv) {
            if (!inv.movimientos || inv.movimientos.length === 0) {
                return inv.numAcciones || null;
            }

            let total = 0;
            inv.movimientos.forEach(m => {
                if (m.numAcciones) {
                    if (m.tipo === 'aportacion') total += m.numAcciones;
                    if (m.tipo === 'retirada') total -= m.numAcciones;
                }
            });

            return total > 0 ? total : (inv.numAcciones || null);
        }

        // -- Calcular precio de compra promedio ponderado --
        function calcularPrecioCompraProm(inv) {
            if (!inv.movimientos || inv.movimientos.length === 0) {
                return inv.precioCompra || null;
            }

            let sumaCosteAcciones = 0;
            let totalAcciones = 0;

            inv.movimientos.forEach(m => {
                if (m.tipo === 'aportacion' && m.numAcciones && m.precio) {
                    sumaCosteAcciones += m.numAcciones * m.precio;
                    totalAcciones += m.numAcciones;
                }
            });

            if (totalAcciones > 0) {
                return sumaCosteAcciones / totalAcciones;
            }

            return inv.precioCompra || null;
        }

        // -- Obtener tasa de cambio EUR/USD desde API --
        async function obtenerTasaCambio(divisaOrigen) {
            if (divisaOrigen === 'EUR') return 1;
            
            try {
                // Usar API de exchangerate-api (gratuita)
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${divisaOrigen}`);
                const data = await response.json();
                return data.rates.EUR || 1;
            } catch (error) {
                console.error('Error obteniendo tasa de cambio:', error);
                // Fallback: tasas aproximadas
                const fallback = { 'USD': 0.92, 'GBP': 1.16, 'JPY': 0.0063, 'CHF': 1.05 };
                return fallback[divisaOrigen] || 1;
            }
        }
        // -- Obtener valor actual de una inversi√≥n (auto-calculado si tiene acciones+precio) --
        // Obtener valor actual de una inversion - VERSION 4.0
        function getValorActual(inv) {
            // Para acciones y crypto, calcular desde numAcciones x precioActual
            if (inv.tipoActivo === 'acciones' || inv.tipoActivo === 'crypto') {
                
                // Usar numAcciones si esta disponible
                let numAcciones = inv.numAcciones;
                
                // Si no, calcular desde movimientos
                if (!numAcciones && inv.movimientos && inv.movimientos.length > 0) {
                    let total = 0;
                    inv.movimientos.forEach(m => {
                        if (m.numAcciones) {
                            if (m.tipo === 'aportacion') total += m.numAcciones;
                            if (m.tipo === 'retirada') total -= m.numAcciones;
                        }
                    });
                    numAcciones = total > 0 ? total : null;
                }
                
                // Usar precio actual si esta disponible, sino precio de compra
                const precio = inv.precioActual || inv.precioCompra;
                
                // Si tenemos ambos, calcular
                if (numAcciones && precio) {
                    const valor = numAcciones * precio;
                    console.log('getValorActual:', inv.nombre, '=', numAcciones, 'x', precio, '=', valor);
                    return valor;
                }
            }
            
            // Fallback: usar valorActual directo
            return inv.valorActual || 0;
        }

        function actualizarOverview() {
            actualizarTarjetasResumen();
            actualizarGraficoEvolucion();
            actualizarAlertas();
        }

        function actualizarTarjetasResumen() {
            const valorTotal = inversiones.reduce((sum, inv) => sum + getValorActual(inv), 0);
            
            // -- MEJORA 1: Total invertido = aportaciones - retiradas --
            const totalInvertido = inversiones.reduce((sum, inv) => {
                let neto = 0;
                if (inv.movimientos && inv.movimientos.length > 0) {
                    inv.movimientos.forEach(m => {
                        if (m.tipo === 'aportacion') neto += m.cantidad;
                        if (m.tipo === 'retirada') neto -= m.cantidad;
                    });
                } else {
                    neto = inv.inversionInicial;
                }
                return sum + neto;
            }, 0);
            
            const objetivoTotal = inversiones.reduce((sum, inv) => sum + inv.objetivo, 0);
            
            // -- MEJORA 2: Rentabilidad total neta (considera retiradas) --
            const beneficio = valorTotal - totalInvertido;
            const rentabilidadTotal = totalInvertido > 0 ? ((beneficio / totalInvertido) * 100) : 0;
            
            // Calcular TIR ponderada del portfolio
            let tirPonderada = 0;
            inversiones.forEach(inv => {
                const tir = calcularTIR(inv);
                const peso = getValorActual(inv);
                tirPonderada += tir * peso;
            });
            tirPonderada = valorTotal > 0 ? tirPonderada / valorTotal : 0;

            const html = `
                <div class="card">
                    <div class="card-title">Valor Total</div>
                    <div class="card-value">‚Ç¨${formatNumber(valorTotal)}</div>
                    <div class="card-subtitle">
                        <span class="${beneficio >= 0 ? 'trend-up' : 'trend-down'}">
                            ${beneficio >= 0 ? '^' : 'v'} ‚Ç¨${formatNumber(Math.abs(beneficio))}
                        </span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Total Invertido</div>
                    <div class="card-value">‚Ç¨${formatNumber(totalInvertido)}</div>
                    <div class="card-subtitle">Neto: aportaciones - retiradas</div>
                </div>
                <div class="card">
                    <div class="card-title">TIR Portfolio</div>
                    <div class="card-value ${tirPonderada >= 0 ? 'success' : 'danger'}">
                        ${tirPonderada >= 0 ? '+' : ''}${tirPonderada.toFixed(2)}%
                    </div>
                    <div class="card-subtitle">Tasa Interna de Retorno anualizada</div>
                </div>
                <div class="card">
                    <div class="card-title">Rentabilidad Total</div>
                    <div class="card-value ${rentabilidadTotal >= 0 ? 'success' : 'danger'}">
                        ${rentabilidadTotal >= 0 ? '+' : ''}${rentabilidadTotal.toFixed(2)}%
                    </div>
                    <div class="card-subtitle">Beneficio neto / Capital invertido</div>
                </div>
                <div class="card">
                    <div class="card-title">Objetivo Total</div>
                    <div class="card-value">‚Ç¨${formatNumber(objetivoTotal)}</div>
                    <div class="card-subtitle">Progreso: ${((valorTotal/objetivoTotal)*100).toFixed(1)}%</div>
                </div>
            `;
            
            document.getElementById('summaryCards').innerHTML = html;
        }

        // --- Estado del rango activo ---
        let currentRange = 'ytd';

        function setRange(btn, range) {
            currentRange = range;
            document.querySelectorAll('.range-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            actualizarGraficoEvolucion();
        }

        // --- Genera un array de claves YYYY-MM desde startDate hasta endDate ---
        function generateMonthKeys(startDate, endDate) {
            const keys = [];
            let y = startDate.getFullYear(), m = startDate.getMonth();
            const ey = endDate.getFullYear(), em = endDate.getMonth();
            while (y < ey || (y === ey && m <= em)) {
                keys.push(`${y}-${String(m + 1).padStart(2, '0')}`);
                m++;
                if (m > 11) { m = 0; y++; }
            }
            return keys;
        }

        // --- Calcula la fecha de inicio seg√∫n el rango activo ---
        function getRangeStart() {
            const hoy = new Date();
            switch (currentRange) {
                case 'ytd':  return new Date(hoy.getFullYear(), 0, 1);
                case '1y':   return new Date(hoy.getFullYear() - 1,  hoy.getMonth(), 1);
                case '3y':   return new Date(hoy.getFullYear() - 3,  hoy.getMonth(), 1);
                case '5y':   return new Date(hoy.getFullYear() - 5,  hoy.getMonth(), 1);
                case '10y':  return new Date(hoy.getFullYear() - 10, hoy.getMonth(), 1);
                default: {   // 'all' -> buscar la fecha m√°s antigua entre inversiones y movimientos
                    let oldest = new Date();
                    inversiones.forEach(inv => {
                        if (inv.fechaInicio) {
                            const d = new Date(inv.fechaInicio);
                            if (d < oldest) oldest = d;
                        }
                        if (inv.movimientos) {
                            inv.movimientos.forEach(m => {
                                const d = new Date(m.fecha);
                                if (d < oldest) oldest = d;
                            });
                        }
                    });
                    return new Date(oldest.getFullYear(), oldest.getMonth(), 1);
                }
            }
        }

        // --- Granularidad: mensual si <= 24 meses, trimestral si <= 60, anual si m√°s ---
        function getGranularity(months) {
            if (months <= 24) return 'month';
            if (months <= 60) return 'quarter';
            return 'year';
        }

        // --- Agrupa claves mensuales seg√∫n granularidad ---
        function aggregateKeys(monthKeys, granularity) {
            if (granularity === 'month') return monthKeys;

            const grouped = {};
            monthKeys.forEach(key => {
                const [y, m] = key.split('-').map(Number);
                let bucket;
                if (granularity === 'quarter') {
                    const q = Math.ceil(m / 3);
                    bucket = `${y} T${q}`;
                } else {
                    bucket = `${y}`;
                }
                if (!grouped[bucket]) grouped[bucket] = [];
                grouped[bucket].push(key);
            });
            return grouped;  // { label: [monthKeys] }
        }

        // --- Formato de etiqueta seg√∫n granularidad ---
        function formatLabel(key, granularity) {
            if (granularity === 'month') {
                const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                const [y, m] = key.split('-').map(Number);
                return `${meses[m-1]} ${y}`;
            }
            return key; // trimestre o a√±o ya viene formateado
        }

        function actualizarGraficoEvolucion() {
            actualizarGraficoAportaciones();
            actualizarGraficoValor();
        }

        function actualizarGraficoAportaciones() {
            const ctx = document.getElementById('aportacionesChart');
            if (!ctx) return;
            if (charts.aportaciones) charts.aportaciones.destroy();

            const hoy = new Date();
            const rangeStart = getRangeStart();
            const rangeEnd = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            const allMonthKeys = generateMonthKeys(rangeStart, rangeEnd);
            const totalMonths = allMonthKeys.length;
            const granularity = getGranularity(totalMonths);

            // Buscar fecha m√°s antigua
            let absoluteOldest = new Date(2010, 0, 1);
            inversiones.forEach(inv => {
                if (inv.fechaInicio) {
                    const d = new Date(inv.fechaInicio);
                    if (d < absoluteOldest) absoluteOldest = d;
                }
                if (inv.movimientos) inv.movimientos.forEach(m => {
                    const d = new Date(m.fecha);
                    if (d < absoluteOldest) absoluteOldest = d;
                });
            });

            const fullKeys = generateMonthKeys(
                new Date(absoluteOldest.getFullYear(), absoluteOldest.getMonth(), 1),
                rangeEnd
            );

            // -- GR√ÅFICO 1: Aportaciones reales acumuladas --
            const flujoMes = {};
            fullKeys.forEach(k => flujoMes[k] = 0);

            inversiones.forEach(inv => {
                if (!inv.movimientos || inv.movimientos.length === 0) {
                    if (inv.fechaInicio) {
                        const d = new Date(inv.fechaInicio);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        if (flujoMes[key] !== undefined) flujoMes[key] += inv.inversionInicial;
                    }
                    return;
                }
                inv.movimientos.forEach(m => {
                    const d = new Date(m.fecha);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (flujoMes[key] === undefined) flujoMes[key] = 0;
                    if (m.tipo === 'aportacion' || m.tipo === 'dividendo') flujoMes[key] += m.cantidad;
                    if (m.tipo === 'retirada' || m.tipo === 'comision') flujoMes[key] -= m.cantidad;
                });
            });

            // Acumulado mensual de aportaciones
            let acum = 0;
            const aportacionesAcumuladas = {};
            fullKeys.forEach(k => {
                acum += (flujoMes[k] || 0);
                aportacionesAcumuladas[k] = acum;
            });

            // -- Aportaciones te√≥ricas necesarias para cumplir objetivos --
            // Para cada inversi√≥n: calcular cu√°nto deber√≠a aportar mensualmente para llegar al objetivo
            const aportacionesTeoricasMes = {};
            fullKeys.forEach(k => aportacionesTeoricasMes[k] = 0);

            inversiones.forEach(inv => {
                if (!inv.fechaInicio || !inv.fechaObjetivo) return;
                const inicio = new Date(inv.fechaInicio);
                const fin = new Date(inv.fechaObjetivo);
                const mesTotales = (fin.getFullYear() - inicio.getFullYear()) * 12 + (fin.getMonth() - inicio.getMonth());
                if (mesTotales <= 0) return;

                // Calcular aportaci√≥n mensual te√≥rica necesaria (sin rentabilidad, simplificado)
                // Total a aportar = objetivo, distribuido linealmente en el tiempo
                const aportacionMensual = inv.objetivo / mesTotales;

                fullKeys.forEach(key => {
                    const [y, m] = key.split('-').map(Number);
                    const meses = (y - inicio.getFullYear()) * 12 + (m - 1 - inicio.getMonth());
                    if (meses >= 0 && meses <= mesTotales) {
                        aportacionesTeoricasMes[key] += aportacionMensual * (meses + 1); // acumulado
                    }
                });
            });

            // Filtrar y agregar seg√∫n granularidad
            const visibleKeys = allMonthKeys;
            let labels, dataReal, dataTeorica;

            if (granularity === 'month') {
                labels = visibleKeys.map(k => formatLabel(k, 'month'));
                dataReal = visibleKeys.map(k => aportacionesAcumuladas[k] || 0);
                dataTeorica = visibleKeys.map(k => aportacionesTeoricasMes[k] || 0);
            } else {
                const grouped = aggregateKeys(visibleKeys, granularity);
                const buckets = Object.keys(grouped);
                labels = buckets;
                dataReal = buckets.map(b => {
                    const keys = grouped[b];
                    return aportacionesAcumuladas[keys[keys.length - 1]] || 0;
                });
                dataTeorica = buckets.map(b => {
                    const keys = grouped[b];
                    return aportacionesTeoricasMes[keys[keys.length - 1]] || 0;
                });
            }

            charts.aportaciones = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Aportaciones Reales',
                            data: dataReal,
                            borderColor: '#00c9a7',
                            backgroundColor: 'rgba(0, 201, 167, 0.08)',
                            fill: true,
                            tension: 0.35,
                            borderWidth: 2.5,
                            pointRadius: dataReal.length <= 13 ? 3 : 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Aportaciones Te√≥ricas Objetivo',
                            data: dataTeorica,
                            borderColor: '#4d9aff',
                            backgroundColor: 'transparent',
                            borderDash: [8, 4],
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 12 }, padding: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ‚Ç¨' + formatNumber(ctx.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45,
                                font: { size: 11 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '‚Ç¨' + formatNumber(v) }
                        }
                    }
                }
            });
        }

        function actualizarGraficoValor() {
            const ctx = document.getElementById('valorChart');
            if (!ctx) return;
            if (charts.valor) charts.valor.destroy();

            const hoy = new Date();
            const rangeStart = getRangeStart();
            const rangeEnd = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            const allMonthKeys = generateMonthKeys(rangeStart, rangeEnd);
            const totalMonths = allMonthKeys.length;
            const granularity = getGranularity(totalMonths);

            // Buscar fecha m√°s antigua
            let absoluteOldest = new Date(2010, 0, 1);
            inversiones.forEach(inv => {
                if (inv.fechaInicio) {
                    const d = new Date(inv.fechaInicio);
                    if (d < absoluteOldest) absoluteOldest = d;
                }
            });

            const fullKeys = generateMonthKeys(
                new Date(absoluteOldest.getFullYear(), absoluteOldest.getMonth(), 1),
                rangeEnd
            );

            // -- GR√ÅFICO 2: Valor real del portfolio --
            const valorRealMes = {};
            fullKeys.forEach(k => valorRealMes[k] = 0);

            inversiones.forEach(inv => {
                const inicio = new Date(inv.fechaInicio || new Date());
                const valorInicial = inv.inversionInicial || 0;
                const valorActual = getValorActual(inv);
                const diasHastaHoy = (hoy - inicio) / (1000 * 60 * 60 * 24);

                fullKeys.forEach(key => {
                    const [y, m] = key.split('-').map(Number);
                    const fechaMes = new Date(y, m - 1, 15);

                    if (fechaMes < inicio) return;

                    const diasTranscurridos = (fechaMes - inicio) / (1000 * 60 * 60 * 24);
                    const fraccion = diasHastaHoy > 0 ? Math.min(diasTranscurridos / diasHastaHoy, 1) : 0;
                    const valorEnMes = valorInicial + (valorActual - valorInicial) * fraccion;

                    valorRealMes[key] += Math.max(0, valorEnMes);
                });
            });

            // -- Valor te√≥rico objetivo --
            const valorTeoricoMes = {};
            fullKeys.forEach(k => valorTeoricoMes[k] = 0);

            inversiones.forEach(inv => {
                if (!inv.fechaInicio || !inv.fechaObjetivo) return;
                const inicio = new Date(inv.fechaInicio);
                const fin = new Date(inv.fechaObjetivo);
                const mesTotales = (fin.getFullYear() - inicio.getFullYear()) * 12 + (fin.getMonth() - inicio.getMonth());
                if (mesTotales <= 0) return;
                const crecMes = (inv.objetivo - inv.inversionInicial) / mesTotales;

                fullKeys.forEach(key => {
                    const [y, m] = key.split('-').map(Number);
                    const meses = (y - inicio.getFullYear()) * 12 + (m - 1 - inicio.getMonth());
                    if (meses >= 0 && meses <= mesTotales) {
                        valorTeoricoMes[key] += inv.inversionInicial + (crecMes * meses);
                    }
                });
            });

            // Filtrar y agregar
            const visibleKeys = allMonthKeys;
            let labels, dataReal, dataTeorica;

            if (granularity === 'month') {
                labels = visibleKeys.map(k => formatLabel(k, 'month'));
                dataReal = visibleKeys.map(k => valorRealMes[k] || 0);
                dataTeorica = visibleKeys.map(k => valorTeoricoMes[k] || 0);
            } else {
                const grouped = aggregateKeys(visibleKeys, granularity);
                const buckets = Object.keys(grouped);
                labels = buckets;
                dataReal = buckets.map(b => {
                    const keys = grouped[b];
                    return valorRealMes[keys[keys.length - 1]] || 0;
                });
                dataTeorica = buckets.map(b => {
                    const keys = grouped[b];
                    return valorTeoricoMes[keys[keys.length - 1]] || 0;
                });
            }

            charts.valor = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Valor Real Portfolio',
                            data: dataReal,
                            borderColor: '#00c9a7',
                            backgroundColor: 'rgba(0, 201, 167, 0.08)',
                            fill: true,
                            tension: 0.35,
                            borderWidth: 2.5,
                            pointRadius: dataReal.length <= 13 ? 3 : 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Valor Te√≥rico Objetivo',
                            data: dataTeorica,
                            borderColor: '#ff9500',
                            backgroundColor: 'transparent',
                            borderDash: [8, 4],
                            tension: 0.35,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { font: { size: 12 }, padding: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ‚Ç¨' + formatNumber(ctx.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45,
                                font: { size: 11 }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: { callback: v => '‚Ç¨' + formatNumber(v) }
                        }
                    }
                }
            });
        }

        // Nueva funci√≥n: Analizar plan de aportaciones
        function analizarPlanAportaciones() {
            // Calcular aportaciones de los √∫ltimos 12 meses
            const hace12Meses = new Date();
            hace12Meses.setMonth(hace12Meses.getMonth() - 12);
            
            let totalAportado12m = 0;
            let totalRetirado12m = 0;
            let numMeses = 12;
            
            inversiones.forEach(inv => {
                if (!inv.movimientos) return;
                
                inv.movimientos.forEach(m => {
                    const fechaMov = new Date(m.fecha);
                    if (fechaMov >= hace12Meses) {
                        if (m.tipo === 'aportacion') {
                            totalAportado12m += m.cantidad;
                        } else if (m.tipo === 'retirada') {
                            totalRetirado12m += m.cantidad;
                        }
                    }
                });
            });
            
            const nettoAportado = totalAportado12m - totalRetirado12m;
            const mediaAportacionMensual = nettoAportado / numMeses;
            
            // Calcular aportaci√≥n mensual necesaria (suma de todas las inversiones)
            const aportacionNecesaria = inversiones.reduce((sum, inv) => {
                return sum + calcularAportacionMensual(inv);
            }, 0);
            
            // Generar alerta seg√∫n el an√°lisis
            let alerta = null;
            
            if (aportacionNecesaria === 0) {
                // No se necesitan m√°s aportaciones
                alerta = {
                    type: 'success',
                    title: ' Plan de Aportaciones: √ìptimo',
                    text: `No necesitas hacer m√°s aportaciones. Tus inversiones alcanzar√°n los objetivos con el valor actual.`
                };
            } else if (mediaAportacionMensual < aportacionNecesaria * 0.5) {
                // Muy por debajo
                alerta = {
                    type: 'danger',
                    title: ' Plan de Aportaciones: Cr√≠tico',
                    text: `Est√°s aportando ‚Ç¨${formatNumber(mediaAportacionMensual)}/mes pero necesitas ‚Ç¨${formatNumber(aportacionNecesaria)}/mes. Est√°s un ${(((aportacionNecesaria - mediaAportacionMensual) / aportacionNecesaria) * 100).toFixed(0)}% por debajo.`
                };
            } else if (mediaAportacionMensual < aportacionNecesaria * 0.8) {
                // Por debajo
                alerta = {
                    type: 'warning',
                    title: 'Ô∏è Plan de Aportaciones: Por debajo',
                    text: `Est√°s aportando ‚Ç¨${formatNumber(mediaAportacionMensual)}/mes pero necesitas ‚Ç¨${formatNumber(aportacionNecesaria)}/mes para alcanzar tus objetivos.`
                };
            } else if (mediaAportacionMensual >= aportacionNecesaria) {
                // Cumpliendo o superando
                alerta = {
                    type: 'success',
                    title: ' Plan de Aportaciones: En buen camino',
                    text: `Est√°s aportando ‚Ç¨${formatNumber(mediaAportacionMensual)}/mes, cumpliendo con los ‚Ç¨${formatNumber(aportacionNecesaria)}/mes necesarios. ¬°Excelente!`
                };
            }
            
            return {
                mediaAportacion: mediaAportacionMensual,
                aportacionNecesaria: aportacionNecesaria,
                totalAportado12m: totalAportado12m,
                totalRetirado12m: totalRetirado12m,
                alerta: alerta
            };
        }

        function actualizarAlertas() {
            const alerts = [];

            // Analizar cada inversi√≥n
            inversiones.forEach(inv => {
                const tir = calcularTIR(inv);
                const diasRestantes = getDaysRemaining(inv.fechaObjetivo);
                const progreso = (getValorActual(inv) / inv.objetivo) * 100;
                const aportacion = calcularAportacionMensual(inv);

                // Alerta: Rentabilidad muy baja
                if (tir < 2) {
                    alerts.push({
                        type: 'danger',
                        title: ` ${inv.nombre} - TIR muy bajo`,
                        text: `Tu TIR es ${tir.toFixed(2)}%, por debajo de la inflaci√≥n. Considera revisar esta inversi√≥n.`
                    });
                }

                // Alerta: Cerca de objetivo con progreso bajo
                if (diasRestantes < 180 && progreso < 70) {
                    alerts.push({
                        type: 'warning',
                        title: ` ${inv.nombre} - Objetivo en riesgo`,
                        text: `Quedan ${Math.floor(diasRestantes/30)} meses y est√°s al ${progreso.toFixed(1)}%. Necesitas ‚Ç¨${formatNumber(aportacion)}/mes.`
                    });
                }

                // Alerta: Superando expectativas
                if (tir > inv.rentabilidadEsperada + 3) {
                    alerts.push({
                        type: 'success',
                        title: ` ${inv.nombre} - ¬°Excelente!`,
                        text: `TIR de ${tir.toFixed(2)}% supera tu objetivo del ${inv.rentabilidadEsperada}%. ¬°Sigue as√≠!`
                    });
                }
            });

            // An√°lisis de diversificaci√≥n
            const diversificacion = analizarDiversificacion();
            if (diversificacion.concentracion > 0.25) {
                alerts.push({
                    type: 'warning',
                    title: 'Ô∏è Portfolio Concentrado',
                    text: diversificacion.recomendacion
                });
            }

            // Comparaci√≥n con benchmark
            const tirPortfolio = inversiones.reduce((sum, inv) => {
                const tir = calcularTIR(inv);
                return sum + (tir * getValorActual(inv));
            }, 0) / inversiones.reduce((s, i) => s + i.valorActual, 0);

            if (tirPortfolio < benchmarks.SP500.rentabilidad - 2) {
                alerts.push({
                    type: 'info',
                    title: ' Comparaci√≥n con Mercado',
                    text: `Tu TIR (${tirPortfolio.toFixed(2)}%) est√° por debajo del S&P 500 (${benchmarks.SP500.rentabilidad}%). Considera fondos indexados.`
                });
            }

            // NUEVO: An√°lisis de plan de aportaciones
            const analisisAportaciones = analizarPlanAportaciones();
            if (analisisAportaciones.alerta) {
                alerts.push(analisisAportaciones.alerta);
            }

            // Renderizar alertas
            const container = document.getElementById('alertsContainer');
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <div class="alert-title"> Todo en orden</div>
                        <div class="alert-text">Tus inversiones van seg√∫n lo planeado</div>
                    </div>
                `;
            } else {
                container.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-text">${alert.text}</div>
                    </div>
                `).join('');
            }
        }

        // ============================================
        // RENDERIZADO: INVERSIONES
        // ============================================

        function renderInversiones() {
            const grid = document.getElementById('investmentsGrid');
            if (inversiones.length === 0) {
                grid.innerHTML = '<div class="card" style="text-align: center; padding: 40px;"><p style="color: var(--text-muted);">No hay inversiones. A√±ade tu primera inversi√≥n.</p></div>';
                return;
            }

            // -- Agrupar por tipo de activo --
            const grupos = {
                'ACCIONES': [],
                'FONDOS': [],
                'BONOS': [],
                'INMOBILIARIO': [],
                'MATERIAS PRIMAS': [],
                'CRYPTO': [],
                'OTROS': []
            };

            inversiones.forEach(inv => {
                const tipo = inv.tipoActivo?.toLowerCase() || 'otros';
                if (tipo === 'acciones') grupos['ACCIONES'].push(inv);
                else if (tipo === 'mixto') grupos['FONDOS'].push(inv);
                else if (tipo === 'bonos') grupos['BONOS'].push(inv);
                else if (tipo === 'inmobiliario') grupos['INMOBILIARIO'].push(inv);
                else if (tipo === 'materiasprimas') grupos['MATERIAS PRIMAS'].push(inv);
                else if (tipo === 'crypto') grupos['CRYPTO'].push(inv);
                else grupos['OTROS'].push(inv);
            });

            let html = '';

            // -- Renderizar cada grupo que tenga inversiones --
            Object.entries(grupos).forEach(([nombreGrupo, invs]) => {
                if (invs.length === 0) return;

                const iconos = {
                    'ACCIONES': '',
                    'FONDOS': '',
                    'BONOS': '',
                    'INMOBILIARIO': '',
                    'MATERIAS PRIMAS': '',
                    'CRYPTO': '‚Çø',
                    'OTROS': ''
                };

                html += `
                    <div style="grid-column: 1 / -1; margin: 30px 0 15px 0;">
                        <h3 style="
                            color: var(--text-primary);
                            font-size: 1.1rem;
                            font-weight: 700;
                            padding-bottom: 12px;
                            border-bottom: 2px solid var(--border);
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        ">
                            <span style="font-size: 1.4rem;">${iconos[nombreGrupo]}</span>
                            ${nombreGrupo}
                            <span style="
                                margin-left: auto;
                                font-size: 0.85rem;
                                font-weight: 400;
                                color: var(--text-secondary);
                            ">${invs.length} inversi√≥n${invs.length !== 1 ? 'es' : ''}</span>
                        </h3>
                    </div>
                `;

                html += invs.map(inv => {
                    const tir = calcularTIR(inv);
                    const progreso = Math.min((inv.valorActual / inv.objetivo) * 100, 100);
                    const aportacionMensual = calcularAportacionMensual(inv);
                    const diasRestantes = getDaysRemaining(inv.fechaObjetivo);
                    
                    const estado = tir >= inv.rentabilidadEsperada - 2 ? 'success' : 
                                  tir >= inv.rentabilidadEsperada - 5 ? 'warning' : 'danger';

                    // -- MEJORA 2: Total invertido = aportaciones - retiros --
                    let totalInvertido = 0;
                    if (inv.movimientos && inv.movimientos.length > 0) {
                        inv.movimientos.forEach(m => {
                            if (m.tipo === 'aportacion') totalInvertido += m.cantidad;
                            if (m.tipo === 'retirada') totalInvertido -= m.cantidad;
                        });
                    } else {
                        totalInvertido = inv.inversionInicial;
                    }

                    // -- MEJORA 1: Valor actual autom√°tico para acciones --
                    let valorActualDisplay = inv.valorActual;
                    let esValorAutoCalculado = false;
                    if ((inv.tipoActivo === 'acciones' || inv.tipoActivo === 'crypto') && 
                        inv.numAcciones && inv.precioActual) {
                        valorActualDisplay = inv.numAcciones * inv.precioActual;
                        esValorAutoCalculado = true;
                    }

                    return `
                        <div class="investment-card">
                            <div class="investment-header">
                                <div class="investment-name">
                                    ${inv.nombre}
                                    ${inv.ticker ? `<span style="color: var(--text-muted); font-size: 0.85em; margin-left: 8px;">${inv.ticker}</span>` : ''}
                                </div>
                                <div class="investment-badges">
                                    <span class="investment-badge badge-${inv.tipoActivo}">${inv.tipoActivo}</span>
                                    <span class="investment-badge badge-${inv.plazo}">${inv.plazo === 'medio' ? 'Medio' : 'Largo'}</span>
                                </div>
                            </div>
                            
                            <div class="progress-bar-container">
                                <div class="progress-bar progress-${estado}" style="width: ${progreso}%">
                                    ${progreso.toFixed(1)}%
                                </div>
                            </div>

                            <div class="investment-details">
                                <div class="detail-item">
                                    <span class="detail-label">Total Invertido</span>
                                    <span class="detail-value">‚Ç¨${formatNumber(totalInvertido)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">
                                        Valor Actual
                                        ${esValorAutoCalculado ? '<span style="color: var(--green); font-size: 0.75em; margin-left: 4px;">*</span>' : ''}
                                    </span>
                                    <span class="detail-value ${valorActualDisplay >= totalInvertido ? 'success' : 'danger'}">
                                        ‚Ç¨${formatNumber(valorActualDisplay)}
                                    </span>
                                </div>
                                ${(inv.tipoActivo === 'acciones' || inv.tipoActivo === 'crypto') && inv.numAcciones ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Acciones</span>
                                        <span class="detail-value">${inv.numAcciones}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Precio Compra (promedio)</span>
                                        <span class="detail-value">‚Ç¨${formatNumber(inv.precioCompra || 0)}</span>
                                    </div>
                                    ${inv.precioActual ? `
                                        <div class="detail-item">
                                            <span class="detail-label">Precio Actual</span>
                                            <span class="detail-value">
                                                ${inv.divisaOriginal && inv.precioActualOriginal ? 
                                                    `${formatNumber(inv.precioActualOriginal)} ${inv.divisaOriginal}<br><small style="color: var(--text-secondary);">‚Ç¨${formatNumber(inv.precioActual)}</small>` :
                                                    `‚Ç¨${formatNumber(inv.precioActual)}`
                                                }
                                            </span>
                                        </div>
                                    ` : ''}
                                ` : ''}
                                <div class="detail-item">
                                    <span class="detail-label">TIR Anualizada</span>
                                    <span class="detail-value ${tir >= 0 ? 'success' : 'danger'}">
                                        ${tir >= 0 ? '+' : ''}${tir.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Objetivo</span>
                                    <span class="detail-value">‚Ç¨${formatNumber(inv.objetivo)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Fecha Objetivo</span>
                                    <span class="detail-value">${formatDate(inv.fechaObjetivo)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">D√≠as Restantes</span>
                                    <span class="detail-value">${diasRestantes}</span>
                                </div>
                                <div class="detail-item" style="grid-column: 1 / -1; background: var(--bg-primary); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                    <span class="detail-label" style="font-weight: bold;"> Aportaci√≥n Mensual Recomendada</span>
                                    <span class="detail-value" style="font-size: 1.4em; color: var(--green);">
                                        ‚Ç¨${formatNumber(aportacionMensual)}/mes
                                    </span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                ${inv.ticker ? `
                                    <button class="btn btn-primary" onclick="actualizarPrecioInversion(${inv.id})" style="flex: 1;" title="Actualizar precio desde Yahoo Finance">
                                        ‚Üª Precio
                                    </button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="abrirMovimientos(${inv.id})" style="flex: 1;">
                                     Movimientos
                                </button>
                                <button class="btn btn-secondary" onclick="editarInversion(${inv.id})" style="flex: 1;">
                                    Ô∏è Editar
                                </button>
                                <button class="btn btn-secondary" onclick="eliminarInversion(${inv.id})" style="flex: 0.5; background: var(--red-dim); color: var(--red);">
                                    Ô∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });

            grid.innerHTML = html;
        }

        function renderAnalisis() {
            renderGraficoDiversificacion();
            renderGraficoPerformance();
            renderGraficoContribucion();
            renderAnalisisRiesgo();
        }

        function renderGraficoDiversificacion() {
            const ctx = document.getElementById('diversificationChart');
            if (!ctx) return;

            if (charts.diversification) {
                charts.diversification.destroy();
            }

            const porActivo = {};
            inversiones.forEach(inv => {
                const tipo = inv.tipoActivo || 'otros';
                porActivo[tipo] = (porActivo[tipo] || 0) + getValorActual(inv);
            });

            const colores = {
                acciones: '#ff4d6a',
                bonos: '#4d9aff',
                mixto: '#f5a623',
                inmobiliario: '#00c9a7',
                crypto: '#a78bfa'
            };

            charts.diversification = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(porActivo).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        data: Object.values(porActivo),
                        backgroundColor: Object.keys(porActivo).map(k => colores[k] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const valor = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const porcentaje = ((valor / total) * 100).toFixed(1);
                                    return `${context.label}: ‚Ç¨${formatNumber(valor)} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // A√±adir an√°lisis
            const diversificacion = analizarDiversificacion();
            document.getElementById('diversificationAnalysis').innerHTML = `
                <div style="padding: 15px; background: var(--bg-primary); border-radius: 10px; margin-top: 15px;">
                    <h3 style="margin-bottom: 10px;"> An√°lisis de Diversificaci√≥n</h3>
                    <p style="color: var(--text-secondary);"><strong>Nivel:</strong> ${diversificacion.nivel}</p>
                    <p style="color: var(--text-secondary); margin-top: 10px;">${diversificacion.recomendacion}</p>
                </div>
            `;
        }

        function renderGraficoPerformance() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            if (charts.performance) {
                charts.performance.destroy();
            }

            const labels = inversiones.map(inv => inv.nombre);
            const tirData = inversiones.map(inv => calcularTIR(inv));
            const objetivoData = inversiones.map(inv => inv.rentabilidadEsperada);

            charts.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'TIR Real',
                            data: tirData,
                            backgroundColor: 'rgba(0, 201, 167, 0.7)',
                            borderColor: '#00c9a7',
                            borderWidth: 2
                        },
                        {
                            label: 'Objetivo',
                            data: objetivoData,
                            backgroundColor: 'rgba(77, 154, 255, 0.7)',
                            borderColor: '#4d9aff',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => value + '%'
                            }
                        }
                    }
                }
            });
        }

        function renderGraficoContribucion() {
            const ctx = document.getElementById('contributionChart');
            if (!ctx) return;

            if (charts.contribution) {
                charts.contribution.destroy();
            }

            const totalInvertido = inversiones.reduce((sum, inv) => {
                return sum + (inv.movimientos ?
                    inv.movimientos.filter(m => m.tipo === 'aportacion')
                        .reduce((s, m) => s + m.cantidad, 0) :
                    inv.inversionInicial);
            }, 0);

            const valorTotal = inversiones.reduce((sum, inv) => sum + getValorActual(inv), 0);
            const beneficio = valorTotal - totalInvertido;

            charts.contribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Aportaciones', 'Rentabilidad'],
                    datasets: [{
                        data: [totalInvertido, Math.max(0, beneficio)],
                        backgroundColor: ['#4d9aff', '#00c9a7']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const valor = context.parsed;
                                    const porcentaje = ((valor / valorTotal) * 100).toFixed(1);
                                    return `${context.label}: ‚Ç¨${formatNumber(valor)} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAnalisisRiesgo() {
            const volatilidades = inversiones.map(inv => inv.volatilidad || 15);
            const volatillidadMedia = volatilidades.reduce((a, b) => a + b, 0) / volatilidades.length;
            
            let nivelRiesgo, colorRiesgo, recomendacion;
            if (volatillidadMedia < 8) {
                nivelRiesgo = 'Bajo';
                colorRiesgo = '#00c9a7';
                recomendacion = 'Portfolio conservador. Considera a√±adir activos de mayor rentabilidad si tu horizonte temporal lo permite.';
            } else if (volatillidadMedia < 15) {
                nivelRiesgo = 'Moderado';
                colorRiesgo = '#f5a623';
                recomendacion = 'Portfolio equilibrado. Buen balance entre riesgo y rentabilidad esperada.';
            } else {
                nivelRiesgo = 'Alto';
                colorRiesgo = '#ff4d6a';
                recomendacion = 'Portfolio agresivo. Aseg√∫rate de tener suficiente tolerancia al riesgo y horizonte temporal largo.';
            }

            const posicionIndicador = Math.min(volatillidadMedia / 25 * 100, 100);

            document.getElementById('riskAnalysis').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Nivel de Riesgo: <span style="color: ${colorRiesgo}">${nivelRiesgo}</span></h3>
                    <div class="risk-meter">
                        <div class="risk-indicator" style="left: ${posicionIndicador}%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        <span>Bajo</span>
                        <span>Moderado</span>
                        <span>Alto</span>
                    </div>
                </div>
                <div style="padding: 15px; background: var(--bg-primary); border-radius: 10px;">
                    <p style="color: var(--text-secondary); margin-bottom: 10px;"><strong>Volatilidad promedio:</strong> ${volatillidadMedia.toFixed(1)}%</p>
                    <p style="color: var(--text-secondary);">${recomendacion}</p>
                </div>
            `;
        }

        // ============================================
        // RENDERIZADO: PROYECCIONES
        // ============================================

        function renderProyecciones() {
            renderMonteCarloChart();
            renderProbabilidadExito();
        }

        function renderMonteCarloChart() {
            if (inversiones.length === 0) return;

            // Simular para la primera inversi√≥n (demo)
            const inv = inversiones[0];
            const simulacion = simularMonteCarlo(inv, 1000);

            const ctx = document.getElementById('monteCarloChart');
            if (!ctx) return;

            if (charts.monteCarlo) {
                charts.monteCarlo.destroy();
            }

            // Crear histograma de resultados
            const bins = 20;
            const min = Math.min(...simulacion.escenarios);
            const max = Math.max(...simulacion.escenarios);
            const binSize = (max - min) / bins;
            
            const histogram = new Array(bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binSize;
                labels.push('‚Ç¨' + formatNumber(binStart));
                
                simulacion.escenarios.forEach(valor => {
                    if (valor >= binStart && valor < binStart + binSize) {
                        histogram[i]++;
                    }
                });
            }

            charts.monteCarlo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: histogram,
                        backgroundColor: 'rgba(77, 154, 255, 0.5)',
                        borderColor: '#4d9aff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y} escenarios`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de escenarios'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Valor final'
                            }
                        }
                    }
                }
            });

            // Mostrar estad√≠sticas
            document.getElementById('monteCarloStats').innerHTML = `
                <h3 style="margin: 20px 0 15px 0;"> Estad√≠sticas de la Simulaci√≥n</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="benchmark-card">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Escenario Pesimista (10%)</div>
                        <div style="font-size: 1.3em; font-weight: bold;">‚Ç¨${formatNumber(simulacion.percentil10)}</div>
                    </div>
                    <div class="benchmark-card">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Escenario Probable (50%)</div>
                        <div style="font-size: 1.3em; font-weight: bold;">‚Ç¨${formatNumber(simulacion.percentil50)}</div>
                    </div>
                    <div class="benchmark-card">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Escenario Optimista (90%)</div>
                        <div style="font-size: 1.3em; font-weight: bold;">‚Ç¨${formatNumber(simulacion.percentil90)}</div>
                    </div>
                    <div class="benchmark-card" style="border-left-color: var(--green);">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Probabilidad de √âxito</div>
                        <div style="font-size: 1.3em; font-weight: bold; color: var(--green);">${simulacion.probabilidadExito.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }

        function renderProbabilidadExito() {
            const probabilidades = inversiones.map(inv => {
                const sim = simularMonteCarlo(inv, 500);
                return {
                    nombre: inv.nombre,
                    probabilidad: sim.probabilidadExito
                };
            });

            const html = probabilidades.map(p => `
                <div class="probability-bar">
                    <div class="probability-label">${p.nombre}</div>
                    <div class="probability-fill">
                        <div class="probability-fill-inner" style="width: ${p.probabilidad}%">
                            ${p.probabilidad.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('probabilityAnalysis').innerHTML = html;
        }

        // ============================================
        // RENDERIZADO: BENCHMARKS
        // ============================================

        function renderBenchmarks() {
            const ctx = document.getElementById('benchmarkChart');
            if (!ctx) return;

            if (charts.benchmark) {
                charts.benchmark.destroy();
            }

            const tirPortfolio = inversiones.reduce((sum, inv) => {
                const tir = calcularTIR(inv);
                return sum + (tir * getValorActual(inv));
            }, 0) / inversiones.reduce((s, i) => s + i.valorActual, 0);

            const labels = ['Tu Portfolio', 'S&P 500', 'MSCI World', 'Euro Stoxx 50', 'Bonos'];
            const data = [
                tirPortfolio,
                benchmarks.SP500.rentabilidad,
                benchmarks.MSCI_WORLD.rentabilidad,
                benchmarks.EUROSTOXX50.rentabilidad,
                benchmarks.BONOS_GLOBAL.rentabilidad
            ];

            charts.benchmark = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Rentabilidad Anualizada (%)',
                        data,
                        backgroundColor: [
                            '#00c9a7',
                            '#4d9aff',
                            '#a78bfa',
                            '#f5a623',
                            '#ff4d6a'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => value + '%'
                            }
                        }
                    }
                }
            });

            // Comparaci√≥n detallada
            const html = Object.entries(benchmarks).map(([key, bench]) => {
                const diferencia = tirPortfolio - bench.rentabilidad;
                const color = diferencia >= 0 ? '#00c9a7' : '#ff4d6a';
                
                return `
                    <div class="benchmark-card">
                        <h4 style="margin-bottom: 10px;">${bench.nombre}</h4>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">
                            Rentabilidad: ${bench.rentabilidad}% | Volatilidad: ${bench.volatilidad}%
                        </div>
                        <div style="font-size: 1.2em; font-weight: bold; color: ${color}; margin-top: 10px;">
                            ${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(2)}% vs tu portfolio
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('benchmarkComparison').innerHTML = html;
        }

        // ============================================
        // MODALES Y FORMULARIOS
        // ============================================

        function openModal(tipo) {
            if (tipo === 'inversion') {
                document.getElementById('inversionModal').classList.add('active');
            } else if (tipo === 'movimiento') {
                document.getElementById('movimientoModal').classList.add('active');
            } else if (tipo === 'importMovimientos') {
                document.getElementById('importMovimientosModal').classList.add('active');
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => {
                if (!m.classList.contains('active') || m.querySelector('.modal-content') === null) {
                    return; // Skip modales temporales
                }
                m.classList.remove('active');
            });
            
            if (document.getElementById('inversionForm')) {
                document.getElementById('inversionForm').reset();
                delete document.getElementById('inversionForm').dataset.editId;
            }
            
            if (document.getElementById('movimientoForm')) {
                document.getElementById('movimientoForm').reset();
            }
            
            if (document.querySelector('.modal-header')) {
                const headers = document.querySelectorAll('.modal-header');
                headers.forEach(h => {
                    if (h.textContent.includes('Editar')) {
                        h.textContent = 'Nueva Inversi√≥n';
                    }
                });
            }
        }

        function editarInversion(id) {
            const inv = inversiones.find(i => i.id === id);
            if (!inv) return;

            document.getElementById('nombre').value = inv.nombre;
            document.getElementById('tipoActivo').value = inv.tipoActivo;
            document.getElementById('ticker').value = inv.ticker || '';
            document.getElementById('isin').value = inv.isin || '';
            document.getElementById('categoria').value = inv.categoria || '';
            document.getElementById('plazo').value = inv.plazo;
            document.getElementById('inversionInicial').value = inv.inversionInicial;
            document.getElementById('fechaInicio').value = inv.fechaInicio;
            document.getElementById('valorActual').value = inv.valorActual;
            document.getElementById('objetivo').value = inv.objetivo;
            document.getElementById('fechaObjetivo').value = inv.fechaObjetivo;
            document.getElementById('rentabilidadEsperada').value = inv.rentabilidadEsperada;
            document.getElementById('volatilidad').value = inv.volatilidad || 15;
            document.getElementById('numAcciones').value = inv.numAcciones || '';
            document.getElementById('precioCompra').value = inv.precioCompra || '';
            
            // Mostrar campos de acciones si aplica
            const tipo = inv.tipoActivo;
            const mostrar = tipo === 'acciones' || tipo === 'crypto';
            document.getElementById('groupNumAcciones').style.display = mostrar ? 'block' : 'none';
            document.getElementById('groupPrecioCompra').style.display = mostrar ? 'block' : 'none';

            document.getElementById('inversionForm').dataset.editId = id;
            document.querySelector('.modal-header').textContent = 'Editar Inversi√≥n';
            
            openModal('inversion');
        }

        function eliminarInversion(id) {
            const inv = inversiones.find(i => i.id === id);
            if (!inv) return;

            if (confirm(`¬øEliminar "${inv.nombre}"?`)) {
                inversiones = inversiones.filter(i => i.id !== id);
                guardarDatos();
                init();
                mostrarNotificacion('Ô∏è Inversi√≥n eliminada');
            }
        }

        function abrirMovimientos(inversionId) {
            const inv = inversiones.find(i => i.id === inversionId);
            if (!inv) return;

            const movimientos = inv.movimientos || [];
            
            const html = `
                <div class="modal-content">
                    <div class="modal-header">Movimientos - ${inv.nombre}</div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="abrirFormMovimiento(${inversionId})" style="flex: 1;">
                            + A√±adir Movimiento
                        </button>
                        <button class="btn btn-secondary" onclick="abrirImportarMovimientos(${inversionId})" style="flex: 1;">
                             Importar Excel/CSV
                        </button>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: var(--blue-dim); border-radius: 8px;">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Total Aportaciones</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: #00c9a7;">
                                ‚Ç¨${formatNumber(movimientos.filter(m => m.tipo === 'aportacion').reduce((s, m) => s + m.cantidad, 0))}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Total Retiradas</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: #ff4d6a;">
                                ‚Ç¨${formatNumber(movimientos.filter(m => m.tipo === 'retirada').reduce((s, m) => s + m.cantidad, 0))}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Movimientos</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--green);">
                                ${movimientos.length}
                            </div>
                        </div>
                    </div>
                    
                    <div class="movements-list">
                        ${movimientos.length === 0 ? 
                            '<p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">No hay movimientos registrados.<br>A√±ade movimientos para calcular el TIR correctamente.</p>' :
                            movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).map((m, idx) => `
                                <div class="movement-item">
                                    <div style="flex: 1;">
                                        <div class="movement-date">${formatDate(m.fecha)}</div>
                                        <div class="movement-type-${m.tipo}" style="font-weight: 600;">
                                            ${m.tipo === 'aportacion' ? ' Aportaci√≥n' : ' Retirada'}
                                        </div>
                                        ${m.descripcion ? `<div style="font-size: 0.85em; color: var(--text-muted); margin-top: 3px;">${m.descripcion}</div>` : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="movement-amount movement-type-${m.tipo}" style="font-size: 1.1em;">
                                            ${m.tipo === 'aportacion' ? '+' : '-'}‚Ç¨${formatNumber(m.cantidad)}
                                        </div>
                                        <button onclick="eliminarMovimiento(${inversionId}, ${idx})" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em; background: var(--red-dim); color: var(--red);">
                                            Ô∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    ${movimientos.length > 0 ? `
                        <button class="btn btn-secondary" onclick="exportarMovimientos(${inversionId})" style="width: 100%; margin-top: 15px;">
                             Exportar a CSV
                        </button>
                    ` : ''}
                    
                    <button class="btn btn-secondary" onclick="document.querySelector('.modal.active').remove()" style="width: 100%; margin-top: 10px;">
                        Cerrar
                    </button>
                </div>
            `;

            // Crear modal temporal
            const tempModal = document.createElement('div');
            tempModal.className = 'modal active';
            tempModal.innerHTML = html;
            tempModal.onclick = (e) => {
                if (e.target === tempModal) {
                    tempModal.remove();
                }
            };
            document.body.appendChild(tempModal);
        }

        function abrirFormMovimiento(inversionId) {
            document.querySelectorAll('.modal').forEach(m => m.classList.contains('active') && m.remove());
            document.getElementById('movimiento_inversionId').value = inversionId;
            document.getElementById('movimiento_fecha').valueAsDate = new Date();
            openModal('movimiento');
        }

        function eliminarMovimiento(inversionId, movimientoIdx) {
            if (!confirm('¬øEliminar este movimiento?')) return;
            
            const inv = inversiones.find(i => i.id === inversionId);
            if (!inv || !inv.movimientos) return;
            
            inv.movimientos.splice(movimientoIdx, 1);
            
            guardarDatos();
            
            // Cerrar y reabrir el modal de movimientos
            document.querySelectorAll('.modal').forEach(m => m.remove());
            abrirMovimientos(inversionId);
            
            mostrarNotificacion('Ô∏è Movimiento eliminado');
        }

        function abrirImportarMovimientos(inversionId) {
            document.querySelectorAll('.modal').forEach(m => m.classList.contains('active') && m.remove());
            
            // Guardar el ID de la inversi√≥n para usarlo despu√©s
            document.getElementById('importMovimientosModal').dataset.inversionId = inversionId;
            
            // Resetear el formulario
            document.getElementById('importMovimientosFile').value = '';
            document.getElementById('previewMovimientos').style.display = 'none';
            document.getElementById('btnConfirmarImportMovimientos').style.display = 'none';
            movimientosTemp = [];
            
            openModal('importMovimientos');
        }

        function descargarPlantillaMovimientos() {
            // Crear un workbook de Excel
            const wb = XLSX.utils.book_new();
            
            // Datos de ejemplo
            const data = [
                ['Fecha', 'Tipo', 'Cantidad', 'Descripcion'],
                ['2024-01-15', 'aportacion', 1000, 'Aportaci√≥n inicial'],
                ['2024-02-15', 'aportacion', 500, 'Aportaci√≥n mensual'],
                ['2024-03-15', 'aportacion', 500, 'Aportaci√≥n mensual'],
                ['2024-04-15', 'aportacion', 500, 'Aportaci√≥n mensual'],
                ['2024-06-20', 'retirada', 300, 'Retiro parcial']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Establecer ancho de columnas
            ws['!cols'] = [
                { wch: 12 }, // Fecha
                { wch: 12 }, // Tipo
                { wch: 10 }, // Cantidad
                { wch: 30 }  // Descripcion
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Movimientos');
            
            // Descargar archivo Excel
            XLSX.writeFile(wb, 'plantilla_movimientos.xlsx');
            
            mostrarNotificacion(' Plantilla Excel descargada', 'info');
        }

        async function procesarArchivoMovimientos(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let contenido;
                
                if (file.name.endsWith('.csv')) {
                    // Procesar CSV
                    contenido = await file.text();
                    movimientosTemp = parsearCSV(contenido);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Procesar Excel con SheetJS
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    movimientosTemp = parsearExcel(jsonData);
                } else {
                    mostrarNotificacion(' Formato no soportado. Use CSV o Excel', 'danger');
                    event.target.value = '';
                    return;
                }

                if (movimientosTemp.length === 0) {
                    mostrarNotificacion(' No se encontraron movimientos v√°lidos', 'danger');
                    return;
                }

                // Mostrar preview
                mostrarPreviewMovimientos();
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion(' Error al procesar archivo: ' + error.message, 'danger');
            }
        }

        function parsearExcel(jsonData) {
            const movimientos = [];
            
            // Saltar la primera fila si es encabezado
            const inicio = jsonData[0] && typeof jsonData[0][0] === 'string' && 
                          jsonData[0][0].toLowerCase().includes('fecha') ? 1 : 0;
            
            for (let i = inicio; i < jsonData.length; i++) {
                const fila = jsonData[i];
                if (!fila || fila.length < 3) continue;
                
                let fecha = fila[0];
                const tipo = String(fila[1]).toLowerCase().trim();
                const cantidad = parseFloat(fila[2]);
                const descripcion = fila[3] ? String(fila[3]) : '';
                
                // Convertir fecha de Excel si es necesario
                if (typeof fecha === 'number') {
                    // Excel almacena fechas como n√∫meros (d√≠as desde 1900-01-01)
                    const excelDate = new Date((fecha - 25569) * 86400 * 1000);
                    fecha = excelDate.toISOString().split('T')[0];
                } else if (typeof fecha === 'string') {
                    // Intentar parsear string de fecha
                    const parsedDate = new Date(fecha);
                    if (!isNaN(parsedDate.getTime())) {
                        fecha = parsedDate.toISOString().split('T')[0];
                    }
                }
                
                // Validar
                if (!fecha || !tipo || isNaN(cantidad)) {
                    console.warn('Fila inv√°lida:', fila);
                    continue;
                }
                
                if (tipo !== 'aportacion' && tipo !== 'retirada') {
                    console.warn('Tipo inv√°lido:', tipo);
                    continue;
                }
                
                // Validar formato de fecha (YYYY-MM-DD)
                if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
                    console.warn('Fecha inv√°lida:', fecha);
                    continue;
                }
                
                movimientos.push({
                    fecha,
                    tipo,
                    cantidad,
                    descripcion
                });
            }
            
            return movimientos;
        }

        function parsearCSV(contenido) {
            const lineas = contenido.split('\n').filter(l => l.trim());
            const movimientos = [];
            
            // Saltar la primera l√≠nea si es encabezado
            const inicio = lineas[0].toLowerCase().includes('fecha') ? 1 : 0;
            
            for (let i = inicio; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (!linea) continue;
                
                // Parsear CSV simple (sin comillas complejas)
                const partes = linea.split(',').map(p => p.trim());
                
                if (partes.length < 3) continue;
                
                const fecha = partes[0];
                const tipo = partes[1].toLowerCase();
                const cantidad = parseFloat(partes[2]);
                const descripcion = partes[3] || '';
                
                // Validar
                if (!fecha || !tipo || isNaN(cantidad)) {
                    console.warn('L√≠nea inv√°lida:', linea);
                    continue;
                }
                
                if (tipo !== 'aportacion' && tipo !== 'retirada') {
                    console.warn('Tipo inv√°lido:', tipo);
                    continue;
                }
                
                // Validar formato de fecha (YYYY-MM-DD)
                if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
                    console.warn('Fecha inv√°lida:', fecha);
                    continue;
                }
                
                movimientos.push({
                    fecha,
                    tipo,
                    cantidad,
                    descripcion
                });
            }
            
            return movimientos;
        }

        function mostrarPreviewMovimientos() {
            const preview = movimientosTemp.slice(0, 5);
            
            const html = preview.map(m => `
                <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                    <div>
                        <span style="font-weight: 600;">${formatDate(m.fecha)}</span>
                        <span style="margin-left: 10px; color: ${m.tipo === 'aportacion' || m.tipo === 'dividendo' ? '#00c9a7' : '#ff4d6a'};">
                            ${m.tipo === 'aportacion' ? ' Aportaci√≥n' : ' Retirada'}
                        </span>
                        ${m.descripcion ? `<br><span style="font-size: 0.85em; color: var(--text-secondary);">${m.descripcion}</span>` : ''}
                    </div>
                    <div style="font-weight: bold; color: ${m.tipo === 'aportacion' || m.tipo === 'dividendo' ? '#00c9a7' : '#ff4d6a'};">
                        ‚Ç¨${formatNumber(m.cantidad)}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('previewMovimientosContent').innerHTML = html;
            document.getElementById('totalMovimientosPreview').textContent = movimientosTemp.length;
            document.getElementById('previewMovimientos').style.display = 'block';
            document.getElementById('btnConfirmarImportMovimientos').style.display = 'block';
            
            mostrarNotificacion(` ${movimientosTemp.length} movimientos listos`, 'success');
        }

        function confirmarImportMovimientos() {
            const inversionId = parseInt(document.getElementById('importMovimientosModal').dataset.inversionId);
            const inv = inversiones.find(i => i.id === inversionId);
            
            if (!inv) {
                mostrarNotificacion(' Inversi√≥n no encontrada', 'danger');
                return;
            }
            
            if (!inv.movimientos) {
                inv.movimientos = [];
            }
            
            // A√±adir los movimientos
            movimientosTemp.forEach(m => {
                // Verificar que no exista ya un movimiento id√©ntico
                const existe = inv.movimientos.some(existing => 
                    existing.fecha === m.fecha && 
                    existing.tipo === m.tipo && 
                    existing.cantidad === m.cantidad
                );
                
                if (!existe) {
                    inv.movimientos.push(m);
                }
            });
            
            // Ordenar por fecha
            inv.movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            guardarDatos();
            closeModal();
            
            // Reabrir ventana de movimientos
            setTimeout(() => {
                abrirMovimientos(inversionId);
            }, 300);
            
            mostrarNotificacion(` ${movimientosTemp.length} movimientos importados`, 'success');
            movimientosTemp = [];
        }

        function exportarMovimientos(inversionId) {
            const inv = inversiones.find(i => i.id === inversionId);
            if (!inv || !inv.movimientos || inv.movimientos.length === 0) {
                mostrarNotificacion(' No hay movimientos para exportar', 'warning');
                return;
            }
            
            // Crear CSV
            let csv = 'Fecha,Tipo,Cantidad,Descripcion\n';
            inv.movimientos.forEach(m => {
                csv += `${m.fecha},${m.tipo},${m.cantidad},"${m.descripcion || ''}"\n`;
            });
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `movimientos_${inv.nombre.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            mostrarNotificacion(' Movimientos exportados', 'success');
        }

        // Event Listeners

        // -- Mostrar/ocultar campos de acciones seg√∫n tipo ---
        document.getElementById('tipoActivo')?.addEventListener('change', function() {
            const tipo = this.value;
            const mostrar = tipo === 'acciones' || tipo === 'crypto';
            document.getElementById('groupNumAcciones').style.display = mostrar ? 'block' : 'none';
            document.getElementById('groupPrecioCompra').style.display = mostrar ? 'block' : 'none';
            if (!mostrar) {
                document.getElementById('numAcciones').value = '';
                document.getElementById('precioCompra').value = '';
            }
        });

        // -- Auto-calcular valorActual = numAcciones x precioCompra ---
        function calcularValorActualDesdeAcciones() {
            const num = parseFloat(document.getElementById('numAcciones').value) || 0;
            const precio = parseFloat(document.getElementById('precioCompra').value) || 0;
            if (num > 0 && precio > 0) {
                const valorCalculado = num * precio;
                document.getElementById('valorActual').value = valorCalculado.toFixed(2);
                // Tambi√©n actualizar inversionInicial si est√° vac√≠o
                if (!document.getElementById('inversionInicial').value) {
                    document.getElementById('inversionInicial').value = valorCalculado.toFixed(2);
                }
            }
        }

        // -- Auto-calcular numAcciones cuando cambia valorActual o precioCompra ---
        document.getElementById('valorActual')?.addEventListener('input', function() {
            const tipo = document.getElementById('tipoActivo').value;
            if (tipo !== 'acciones' && tipo !== 'crypto') return;
            
            const valor = parseFloat(this.value) || 0;
            const precio = parseFloat(document.getElementById('precioCompra').value) || 0;
            if (valor > 0 && precio > 0) {
                const numCalculado = valor / precio;
                document.getElementById('numAcciones').value = numCalculado.toFixed(8);
            }
        });

        // -- Auto-calcular precioCompra cuando cambia valorActual o numAcciones ---
        document.getElementById('numAcciones')?.addEventListener('blur', function() {
            const tipo = document.getElementById('tipoActivo').value;
            if (tipo !== 'acciones' && tipo !== 'crypto') return;
            
            const num = parseFloat(this.value) || 0;
            const valor = parseFloat(document.getElementById('valorActual').value) || 0;
            if (num > 0 && valor > 0 && !document.getElementById('precioCompra').value) {
                const precioCalculado = valor / num;
                document.getElementById('precioCompra').value = precioCalculado.toFixed(2);
            }
        });

        document.getElementById('inversionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editId = this.dataset.editId;
            const datos = {
                nombre: document.getElementById('nombre').value,
                tipoActivo: document.getElementById('tipoActivo').value,
                ticker: document.getElementById('ticker').value || null,
                isin: document.getElementById('isin').value || null,
                categoria: document.getElementById('categoria').value || null,
                plazo: document.getElementById('plazo').value,
                inversionInicial: parseFloat(document.getElementById('inversionInicial').value),
                fechaInicio: document.getElementById('fechaInicio').value,
                valorActual: parseFloat(document.getElementById('valorActual').value),
                objetivo: parseFloat(document.getElementById('objetivo').value),
                fechaObjetivo: document.getElementById('fechaObjetivo').value,
                rentabilidadEsperada: parseFloat(document.getElementById('rentabilidadEsperada').value),
                volatilidad: parseFloat(document.getElementById('volatilidad').value) || 15,
                numAcciones: document.getElementById('numAcciones').value ? parseFloat(document.getElementById('numAcciones').value) : null,
                precioCompra: document.getElementById('precioCompra').value ? parseFloat(document.getElementById('precioCompra').value) : null
            };

            if (editId) {
                const index = inversiones.findIndex(i => i.id == editId);
                if (index !== -1) {
                    inversiones[index] = { ...inversiones[index], ...datos };
                    mostrarNotificacion(' Inversi√≥n actualizada');
                }
            } else {
                inversiones.push({
                    id: Date.now(),
                    ...datos,
                    movimientos: [{
                        tipo: 'aportacion',
                        cantidad: datos.inversionInicial,
                        fecha: datos.fechaInicio,
                        descripcion: 'Inversi√≥n inicial'
                    }]
                });
                mostrarNotificacion(' Inversi√≥n creada');
            }

            guardarDatos();
            init();
            closeModal();
        });

        document.getElementById('movimientoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const inversionId = parseInt(document.getElementById('movimiento_inversionId').value);
            const inv = inversiones.find(i => i.id === inversionId);
            
            if (!inv) return;

            if (!inv.movimientos) inv.movimientos = [];

            const movimiento = {
                tipo: document.getElementById('movimiento_tipo').value,
                cantidad: parseFloat(document.getElementById('movimiento_cantidad').value),
                fecha: document.getElementById('movimiento_fecha').value,
                descripcion: document.getElementById('movimiento_descripcion').value || ''
            };

            inv.movimientos.push(movimiento);
            
            // Ordenar por fecha
            inv.movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            guardarDatos();
            closeModal();
            
            // Reabrir ventana de movimientos
            setTimeout(() => {
                abrirMovimientos(inversionId);
            }, 100);
            
            mostrarNotificacion(' Movimiento a√±adido');
        });

        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        // ============================================
        // PASO 7: AUTO-ACTUALIZACI√ìN DE PRECIOS (Yahoo Finance)
        // ============================================


        // -- Normalizar ticker seg√∫n el mercado --
        function normalizarTicker(ticker) {
            if (!ticker) return ticker;
            
            ticker = ticker.trim().toUpperCase();
            
            // Patrones conocidos para diferentes mercados
            const patrones = {
                // Bolsa Espa√±ola (IBEX 35) - a√±adir .MC
                'TEF': 'TEF.MC',      // Telef√≥nica
                'SAN': 'SAN.MC',      // Santander
                'BBVA': 'BBVA.MC',    // BBVA
                'IBE': 'IBE.MC',      // Iberdrola
                'ITX': 'ITX.MC',      // Inditex
                'REP': 'REP.MC',      // Repsol
                'CABK': 'CABK.MC',    // CaixaBank
                'FER': 'FER.MC',      // Ferrovial
                'ACS': 'ACS.MC',      // ACS
                'ENG': 'ENG.MC',      // Enag√°s
                
                // Si ya tiene .MC, dejarlo
                // Si tiene 3-4 letras sin punto, podr√≠a ser espa√±ol
            };
            
            // Si est√° en patrones conocidos, usar la versi√≥n correcta
            if (patrones[ticker]) {
                return patrones[ticker];
            }
            
            // Si ya tiene sufijo, dejarlo como est√°
            if (ticker.includes('.') || ticker.includes('-')) {
                return ticker;
            }
            
            // Detectar por longitud y caracter√≠sticas
            // Acciones USA: generalmente 1-5 letras sin sufijo
            // Acciones Europa: generalmente necesitan sufijo
            
            // Si son 3-4 letras may√∫sculas y no es un ticker USA conocido
            const tickersUSAComunes = [
                'AAPL', 'MSFT', 'GOOGL', 'GOOG', 'AMZN', 'TSLA', 'META', 'NVDA',
                'AMD', 'INTC', 'NFLX', 'DIS', 'BA', 'JPM', 'BAC', 'WMT', 'XOM',
                'VOO', 'VTI', 'SPY', 'QQQ', 'IWM', 'VEA', 'VWO', 'AGG', 'BND',
                'GLD', 'SLV', 'USO', 'TLT', 'ARKK', 'ARKG', 'ARKW'
            ];
            
            if (tickersUSAComunes.includes(ticker)) {
                return ticker;
            }
            
            // Si tiene exactamente 3 letras y no est√° en lista USA, probablemente es espa√±ol
            if (ticker.length === 3 && /^[A-Z]{3}$/.test(ticker)) {
                console.log(`Ô∏è Ticker "${ticker}" detectado como posible acci√≥n espa√±ola. Agregando .MC`);
                return ticker + '.MC';
            }
            
            // Acciones de 4 letras may√∫sculas sin n√∫meros podr√≠an ser espa√±olas
            if (ticker.length === 4 && /^[A-Z]{4}$/.test(ticker) && !tickersUSAComunes.includes(ticker)) {
                console.log(`Ô∏è Ticker "${ticker}" detectado como posible acci√≥n espa√±ola. Agregando .MC`);
                return ticker + '.MC';
            }
            
            return ticker;
        }

        // -- Gu√≠a de sufijos para diferentes mercados --
        function obtenerGuiaTickers() {
            return `
 GU√çA DE FORMATOS DE TICKER POR MERCADO

 ESTADOS UNIDOS (NYSE, NASDAQ):
   Sin sufijo: AAPL, MSFT, GOOGL, TSLA, AMZN
   
 ESPA√ëA (BME - Bolsa de Madrid):
   Sufijo .MC: TEF.MC, SAN.MC, BBVA.MC, IBE.MC, ITX.MC
   
 REINO UNIDO (LSE - London Stock Exchange):
   Sufijo .L: LLOY.L, BARC.L, BP.L, SHEL.L
   
 ALEMANIA (XETRA - Frankfurt):
   Sufijo .DE: BMW.DE, SAP.DE, VOW3.DE, SIE.DE
   
 FRANCIA (Euronext Paris):
   Sufijo .PA: MC.PA, OR.PA, SAN.PA, BNP.PA
   
 ITALIA (Borsa Italiana):
   Sufijo .MI: ENI.MI, ISP.MI, UCG.MI, ENEL.MI
   
 CANAD√Å (TSX):
   Sufijo .TO: TD.TO, RY.TO, SHOP.TO, SU.TO
   
 AUSTRALIA (ASX):
   Sufijo .AX: BHP.AX, CBA.AX, NAB.AX, WBC.AX
   
 JAP√ìN (TSE):
   C√≥digo num√©rico + .T: 7203.T (Toyota), 6758.T (Sony)
   
 SUIZA (SIX Swiss Exchange):
   Sufijo .SW: NESN.SW, NOVN.SW, ROG.SW
   
 BRASIL (B3):
   Sufijo .SA: PETR4.SA, VALE3.SA, ITUB4.SA

‚Çø CRIPTOMONEDAS:
   Bitcoin: BTC-USD
   Ethereum: ETH-USD
   Cardano: ADA-USD
   Polkadot: DOT-USD

 EJEMPLOS COMPLETOS:
    Correcto: TEF.MC, AAPL, BTC-USD, 7203.T
    Incorrecto: TEF (sin .MC), APPLE, BTC
`;
        }
        async function actualizarPrecioDesdeYahoo(ticker) {
            try {
                // Normalizar ticker seg√∫n mercado
                ticker = normalizarTicker(ticker);
                console.log(` Buscando precio para: ${ticker}`);
                
                // Yahoo Finance API p√∫blica
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const precio = result.meta.regularMarketPrice;
                    const cambio = result.meta.regularMarketChange || 0;
                    const cambioPct = result.meta.regularMarketChangePercent || 0;
                    
                    return {
                        precio: precio,
                        cambio: cambio,
                        cambioPct: cambioPct,
                        moneda: result.meta.currency || 'USD',
                        timestamp: new Date(result.meta.regularMarketTime * 1000)
                    };
                }
                
                console.warn(`Ô∏è No se encontraron datos para ticker: ${ticker}`);
                console.log(' Verifica el formato del ticker. Usa mostrarGuiaTickers() para ver ejemplos.');
                return null;
            } catch (error) {
                console.error(` Error al obtener precio para ${ticker}:`, error);
                console.log(' Posibles causas:');
                console.log('   1. Ticker incorrecto (usa mostrarGuiaTickers() para ver formatos)');
                console.log('   2. Mercado cerrado (precios solo durante horario de mercado)');
                console.log('   3. S√≠mbolo no existe en Yahoo Finance');
                return null;
            }
        }

        // -- Actualizar precio de una inversi√≥n individual con conversi√≥n de divisa --

        // ================================================================
        // ACTUALIZACION DE PRECIOS - VERSION 4.0 SIMPLIFICADA
        // ================================================================

        async function actualizarPrecioInversion(invId) {
            console.log('=== INICIANDO ACTUALIZACION DE PRECIO ===');
            console.log('ID inversion:', invId);
            
            const inv = inversiones.find(i => i.id === invId);
            if (!inv) {
                console.error('Inversion no encontrada:', invId);
                mostrarNotificacion('Error: inversion no encontrada', 'danger');
                return;
            }
            
            if (!inv.ticker) {
                console.error('Inversion sin ticker:', inv.nombre);
                mostrarNotificacion('Esta inversion no tiene ticker configurado', 'danger');
                return;
            }

            console.log('Inversion:', inv.nombre);
            console.log('Ticker original:', inv.ticker);
            
            // Normalizar ticker
            const tickerNormalizado = normalizarTicker(inv.ticker);
            console.log('Ticker normalizado:', tickerNormalizado);

            mostrarNotificacion('Actualizando precio de ' + inv.nombre + '...', 'info');

            try {
                // 1. Obtener precio de Yahoo Finance
                const datosPrecio = await obtenerPrecioYahoo(tickerNormalizado);
                
                if (!datosPrecio) {
                    throw new Error('No se pudo obtener precio de Yahoo Finance');
                }

                console.log('Precio obtenido:', datosPrecio);

                // 2. Calcular o usar numero de acciones
                let numAcciones = inv.numAcciones;
                
                // Si tiene movimientos, calcular desde ahi
                if (inv.movimientos && inv.movimientos.length > 0) {
                    let totalAcciones = 0;
                    inv.movimientos.forEach(m => {
                        if (m.numAcciones) {
                            if (m.tipo === 'aportacion') totalAcciones += m.numAcciones;
                            if (m.tipo === 'retirada') totalAcciones -= m.numAcciones;
                        }
                    });
                    if (totalAcciones > 0) {
                        numAcciones = totalAcciones;
                        console.log('Acciones calculadas desde movimientos:', numAcciones);
                    }
                }
                
                // Si aun no tiene, calcular desde inversion inicial
                if (!numAcciones && inv.inversionInicial) {
                    numAcciones = inv.inversionInicial / datosPrecio.precio;
                    console.log('Acciones calculadas desde inversion inicial:', numAcciones);
                }

                // 3. Convertir precio a EUR si es necesario
                let precioEUR = datosPrecio.precio;
                let tasaCambio = 1;
                
                if (datosPrecio.moneda !== 'EUR') {
                    tasaCambio = await obtenerTasaCambioSimple(datosPrecio.moneda);
                    precioEUR = datosPrecio.precio * tasaCambio;
                    console.log('Conversion:', datosPrecio.precio, datosPrecio.moneda, '=', precioEUR, 'EUR');
                }

                // 4. Calcular valor actual
                const valorActualCalculado = numAcciones * precioEUR;
                
                console.log('Calculo final:');
                console.log('  Acciones:', numAcciones);
                console.log('  Precio EUR:', precioEUR);
                console.log('  Valor total:', valorActualCalculado);

                // 5. Guardar todo en la inversion
                inv.numAcciones = numAcciones;
                inv.precioActual = precioEUR;
                inv.precioActualOriginal = datosPrecio.precio;
                inv.divisaOriginal = datosPrecio.moneda;
                inv.tasaCambio = tasaCambio;
                inv.valorActual = valorActualCalculado;
                inv.ultimaActualizacion = new Date().toISOString();

                // 6. Guardar y actualizar UI
                guardarDatos();
                renderInversiones();
                actualizarOverview();

                console.log('=== PRECIO ACTUALIZADO CORRECTAMENTE ===');
                
                mostrarNotificacion(
                    inv.nombre + ': ' + datosPrecio.precio.toFixed(2) + ' ' + datosPrecio.moneda + 
                    ' = ' + precioEUR.toFixed(2) + ' EUR',
                    'success'
                );

            } catch (error) {
                console.error('Error en actualizacion de precio:', error);
                mostrarNotificacion('Error: ' + error.message, 'danger');
            }
        }

        async function obtenerPrecioYahoo(ticker) {
            console.log('Consultando Yahoo Finance:', ticker);
            
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Yahoo Finance HTTP error:', response.status);
                    return null;
                }
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    return {
                        precio: result.meta.regularMarketPrice,
                        moneda: result.meta.currency || 'USD'
                    };
                }
                
                console.error('Yahoo Finance: estructura de datos invalida');
                return null;
                
            } catch (error) {
                console.error('Error consultando Yahoo Finance:', error);
                return null;
            }
        }

        async function obtenerTasaCambioSimple(divisaOrigen) {
            if (divisaOrigen === 'EUR') return 1;
            
            try {
                const url = `https://api.exchangerate-api.com/v4/latest/${divisaOrigen}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.rates.EUR || 1;
            } catch (error) {
                console.warn('Error obteniendo tasa de cambio, usando fallback');
                const fallback = { 'USD': 0.92, 'GBP': 1.16, 'JPY': 0.0063 };
                return fallback[divisaOrigen] || 1;
            }
        }


        async function actualizarTodasLasInversiones() {
            const btn = document.getElementById('btnActualizarPrecios');
            if (!btn) return;
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚ü≥</span> Actualizando...';
            btn.disabled = true;
            
            let actualizadas = 0;
            let errores = 0;
            
            for (const inv of inversiones) {
                if (inv.ticker) {
                    try {
                        const datosPrecio = await actualizarPrecioDesdeYahoo(inv.ticker);
                        
                        if (datosPrecio) {
                            // Calcular n√∫mero de acciones que tiene
                            // Asumimos que la inversi√≥n inicial compr√≥ al precio hist√≥rico
                            // y mantenemos ese n√∫mero de acciones
                            
                            if (!inv.numAcciones) {
                                // Primera vez: calcular n√∫mero de acciones basado en inversi√≥n inicial
                                // Usamos el precio actual como aproximaci√≥n
                                inv.numAcciones = inv.inversionInicial / datosPrecio.precio;
                            }
                            
                            // Actualizar valor actual basado en precio y n√∫mero de acciones
                            const nuevoValor = inv.numAcciones * datosPrecio.precio;
                            
                            // Guardar precio e info
                            inv.valorActual = nuevoValor;
                            inv.precioActual = datosPrecio.precio;
                            inv.ultimaActualizacion = new Date().toISOString();
                            inv.moneda = datosPrecio.moneda;
                            
                            actualizadas++;
                        } else {
                            errores++;
                        }
                        
                        // Delay para no saturar la API
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`Error actualizando ${inv.ticker}:`, error);
                        errores++;
                    }
                }
            }
            
            guardarDatos();
            init();
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (actualizadas > 0) {
                mostrarNotificacion(` ${actualizadas} inversiones actualizadas`, 'success');
            }
            
            if (errores > 0) {
                mostrarNotificacion(`Ô∏è ${errores} inversiones no se pudieron actualizar`, 'warning');
            }
            
            if (actualizadas === 0 && errores === 0) {
                mostrarNotificacion('‚ÑπÔ∏è No hay inversiones con ticker para actualizar', 'info');
            }
        }

        // ============================================
        // PASO 8: VOLATILIDAD AUTOM√ÅTICA (5 a√±os)
        // ============================================

        async function obtenerVolatilidadYahoo(ticker) {
            try {
                // Obtener datos hist√≥ricos de 5 a√±os
                const ahora = Math.floor(Date.now() / 1000);
                const hace5anos = ahora - (5 * 365 * 24 * 60 * 60);
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?period1=${hace5anos}&period2=${ahora}&interval=1d`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const precios = result.indicators.quote[0].close;
                    
                    // Filtrar valores nulos
                    const preciosValidos = precios.filter(p => p !== null);
                    
                    if (preciosValidos.length < 100) {
                        return null; // No hay suficientes datos
                    }
                    
                    // Calcular retornos diarios
                    const retornos = [];
                    for (let i = 1; i < preciosValidos.length; i++) {
                        const retorno = (preciosValidos[i] - preciosValidos[i-1]) / preciosValidos[i-1];
                        retornos.push(retorno);
                    }
                    
                    // Calcular desviaci√≥n est√°ndar de retornos
                    const media = retornos.reduce((a, b) => a + b, 0) / retornos.length;
                    const varianza = retornos.reduce((sum, r) => sum + Math.pow(r - media, 2), 0) / retornos.length;
                    const desviacionDiaria = Math.sqrt(varianza);
                    
                    // Anualizar volatilidad (252 d√≠as de trading al a√±o)
                    const volatilidad = desviacionDiaria * Math.sqrt(252) * 100;
                    
                    return volatilidad;
                }
                
                return null;
            } catch (error) {
                console.error('Error al obtener volatilidad:', error);
                return null;
            }
        }

        async function actualizarVolatilidadInversiones() {
            let actualizadas = 0;
            
            for (const inv of inversiones) {
                if (inv.ticker && (!inv.volatilidad || inv.volatilidad === 15)) {
                    const vol = await obtenerVolatilidadYahoo(inv.ticker);
                    
                    if (vol) {
                        inv.volatilidad = Math.round(vol * 10) / 10; // Redondear a 1 decimal
                        actualizadas++;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            if (actualizadas > 0) {
                guardarDatos();
                mostrarNotificacion(` Volatilidad actualizada para ${actualizadas} inversiones`, 'success');
            }
            
            return actualizadas;
        }

        // ============================================
        // PASO 9: M√âTRICAS DE ACCIONES + HOLDINGS
        // ============================================

        async function obtenerMetricasAccion(ticker) {
            try {
                // Obtener datos fundamentales de Yahoo Finance
                const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=defaultKeyStatistics,summaryDetail,price`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.quoteSummary && data.quoteSummary.result && data.quoteSummary.result[0]) {
                    const result = data.quoteSummary.result[0];
                    const stats = result.defaultKeyStatistics || {};
                    const summary = result.summaryDetail || {};
                    const price = result.price || {};
                    
                    return {
                        pe: stats.trailingPE?.raw || null,
                        forwardPE: stats.forwardPE?.raw || null,
                        dividendYield: summary.dividendYield?.raw ? (summary.dividendYield.raw * 100) : null,
                        marketCap: price.marketCap?.raw || null,
                        beta: stats.beta?.raw || null,
                        eps: stats.trailingEps?.raw || null,
                        peRatio: stats.priceToBook?.raw || null,
                        sector: price.sector || null,
                        industry: price.industry || null
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error al obtener m√©tricas:', error);
                return null;
            }
        }

        async function obtenerHoldingsFondo(isin) {
            // NOTA: Obtener holdings reales requiere APIs de pago (Morningstar, Bloomberg)
            // Esta es una implementaci√≥n simulada para demostraci√≥n
            
            try {
                // En producci√≥n real, aqu√≠ ir√≠an llamadas a APIs como:
                // - Morningstar API (de pago)
                // - Bloomberg API (de pago)
                // - Scraping de sitios p√∫blicos (complejo y fr√°gil)
                
                // Por ahora, retornamos estructura de ejemplo
                return {
                    disponible: false,
                    mensaje: 'Holdings de fondos requiere API premium. Puedes a√±adirlos manualmente.',
                    holdings: [],
                    fondosSimilares: []
                };
            } catch (error) {
                console.error('Error al obtener holdings:', error);
                return null;
            }
        }

        // Funci√≥n para buscar fondos similares por categor√≠a
        function buscarFondosSimilaresPorCategoria(categoria) {
            if (!categoria) return [];
            
            // Base de datos simulada de fondos populares por categor√≠a
            const fondosPorCategoria = {
                'tech': [
                    { nombre: 'Vanguard Information Technology ETF', ticker: 'VGT', isin: 'US9229087690' },
                    { nombre: 'Technology Select Sector SPDR', ticker: 'XLK', isin: 'US81369Y8030' },
                    { nombre: 'ARK Innovation ETF', ticker: 'ARKK', isin: 'US00214Q1040' }
                ],
                'value': [
                    { nombre: 'Vanguard Value ETF', ticker: 'VTV', isin: 'US9229083632' },
                    { nombre: 'iShares Russell 1000 Value', ticker: 'IWD', isin: 'US4642872349' },
                    { nombre: 'Vanguard Mega Cap Value ETF', ticker: 'MGV', isin: 'US9229087443' }
                ],
                'growth': [
                    { nombre: 'Vanguard Growth ETF', ticker: 'VUG', isin: 'US9229083549' },
                    { nombre: 'iShares Russell 1000 Growth', ticker: 'IWF', isin: 'US4642874659' },
                    { nombre: 'Vanguard Mega Cap Growth', ticker: 'MGK', isin: 'US9229087286' }
                ],
                'global': [
                    { nombre: 'Vanguard Total World Stock ETF', ticker: 'VT', isin: 'US9220427424' },
                    { nombre: 'iShares MSCI ACWI ETF', ticker: 'ACWI', isin: 'US4642858586' },
                    { nombre: 'SPDR MSCI ACWI IMI', ticker: 'ACIM', isin: 'US78468R6229' }
                ],
                'healthcare': [
                    { nombre: 'Health Care Select Sector SPDR', ticker: 'XLV', isin: 'US81369Y4040' },
                    { nombre: 'Vanguard Health Care ETF', ticker: 'VHT', isin: 'US9229086231' },
                    { nombre: 'iShares US Healthcare ETF', ticker: 'IYH', isin: 'US4642886398' }
                ],
                'finance': [
                    { nombre: 'Financial Select Sector SPDR', ticker: 'XLF', isin: 'US81369Y2067' },
                    { nombre: 'Vanguard Financials ETF', ticker: 'VFH', isin: 'US9229086579' },
                    { nombre: 'iShares US Financials ETF', ticker: 'IYF', isin: 'US4642863926' }
                ]
            };
            
            return fondosPorCategoria[categoria.toLowerCase()] || [];
        }

        // Renderizar pesta√±a de Holdings & M√©tricas
        async function renderHoldingsYMetricas() {
            const container = document.getElementById('holdingsContent');
            if (!container) return;
            
            let html = '<div style="display: grid; gap: 30px;">';
            
            // Secci√≥n 1: M√©tricas de Acciones
            const accionesConTicker = inversiones.filter(inv => 
                inv.ticker && (inv.tipoActivo === 'acciones' || !inv.tipoActivo)
            );
            
            if (accionesConTicker.length > 0) {
                html += `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title"> M√©tricas de Acciones</h3>
                            <button class="btn btn-primary" onclick="cargarMetricasAcciones()" style="font-size: 0.85em;">
                                 Actualizar M√©tricas
                            </button>
                        </div>
                        <div id="metricas-acciones-container"></div>
                    </div>
                `;
            }
            
            // Secci√≥n 2: Holdings de Fondos
            const fondos = inversiones.filter(inv => inv.isin && inv.tipoActivo === 'mixto');
            
            if (fondos.length > 0) {
                html += `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title"> Holdings de Fondos</h3>
                        </div>
                        <div class="alert alert-info">
                            <div class="alert-title">‚ÑπÔ∏è Holdings de Fondos</div>
                            <div class="alert-text">
                                Para obtener los holdings reales de fondos se requiere una API premium (Morningstar, Bloomberg).
                                <br><br>
                                <strong>Opciones:</strong><br>
                                1. A√±adir manualmente los holdings principales<br>
                                2. Subscribirse a Morningstar API (~$100/mes)<br>
                                3. Usar scraping (complejo y fr√°gil)
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Secci√≥n 3: Fondos Similares por Categor√≠a
            const inversionesConCategoria = inversiones.filter(inv => inv.categoria);
            
            if (inversionesConCategoria.length > 0) {
                html += `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title"> Fondos Similares por Categor√≠a</h3>
                        </div>
                        <div id="fondos-similares-container"></div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Cargar m√©tricas y fondos similares
            if (accionesConTicker.length > 0) {
                await renderMetricasAcciones();
            }
            
            if (inversionesConCategoria.length > 0) {
                renderFondosSimilares();
            }
        }

        async function cargarMetricasAcciones() {
            const container = document.getElementById('metricas-acciones-container');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; padding: 20px;">‚ü≥ Cargando m√©tricas...</p>';
            
            const accionesConTicker = inversiones.filter(inv => inv.ticker);
            const metricas = [];
            
            for (const inv of accionesConTicker) {
                const datos = await obtenerMetricasAccion(inv.ticker);
                if (datos) {
                    metricas.push({
                        nombre: inv.nombre,
                        ticker: inv.ticker,
                        ...datos
                    });
                }
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Guardar m√©tricas en las inversiones
            metricas.forEach(m => {
                const inv = inversiones.find(i => i.ticker === m.ticker);
                if (inv) {
                    inv.metricas = m;
                }
            });
            
            guardarDatos();
            renderMetricasAcciones();
        }

        function renderMetricasAcciones() {
            const container = document.getElementById('metricas-acciones-container');
            if (!container) return;
            
            const accionesConMetricas = inversiones.filter(inv => inv.metricas);
            
            if (accionesConMetricas.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No hay m√©tricas cargadas. Presiona "Actualizar M√©tricas" para cargarlas.
                    </p>
                `;
                return;
            }
            
            const html = accionesConMetricas.map(inv => {
                const m = inv.metricas;
                return `
                    <div style="border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 15px; font-size: 1.2em;">${inv.nombre} (${inv.ticker})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            ${m.pe ? `
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">P/E Ratio</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">${m.pe.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            ${m.dividendYield ? `
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">Dividend Yield</div>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #00c9a7;">${m.dividendYield.toFixed(2)}%</div>
                                </div>
                            ` : ''}
                            ${m.beta ? `
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">Beta</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">${m.beta.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            ${m.marketCap ? `
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">Market Cap</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">$${(m.marketCap / 1e9).toFixed(1)}B</div>
                                </div>
                            ` : ''}
                            ${m.eps ? `
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">EPS</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">$${m.eps.toFixed(2)}</div>
                                </div>
                            ` : ''}
                        </div>
                        ${m.sector ? `<p style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);"><strong>Sector:</strong> ${m.sector}</p>` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderFondosSimilares() {
            const container = document.getElementById('fondos-similares-container');
            if (!container) return;
            
            const categorias = [...new Set(inversiones.filter(inv => inv.categoria).map(inv => inv.categoria))];
            
            let html = '';
            
            categorias.forEach(cat => {
                const similares = buscarFondosSimilaresPorCategoria(cat);
                
                if (similares.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 15px; text-transform: capitalize;">${cat}</h4>
                            <div style="display: grid; gap: 10px;">
                                ${similares.map(fondo => `
                                    <div style="border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600;">${fondo.nombre}</div>
                                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                                ${fondo.ticker} * ${fondo.isin}
                                            </div>
                                        </div>
                                        <button class="btn btn-secondary" onclick="copiarISIN('${fondo.isin}')" style="font-size: 0.85em;">
                                             Copiar ISIN
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function copiarISIN(isin) {
            navigator.clipboard.writeText(isin).then(() => {
                mostrarNotificacion(' ISIN copiado: ' + isin, 'success');
            }).catch(() => {
                mostrarNotificacion('Error al copiar', 'danger');
            });
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        function init() {
            cargarDatos();
            actualizarOverview();
            if (currentTab === 'inversiones') renderInversiones();
            if (currentTab === 'analisis') renderAnalisis();
            if (currentTab === 'proyecciones') renderProyecciones();
            if (currentTab === 'benchmarks') renderBenchmarks();
        }

        // Iniciar aplicaci√≥n
        init();
    </script>
</body>
</html>